---
node_id: 3264
title: Configure Remote Access VPN Service on a Vyatta Appliance
permalink: article/configure-vpn-access-using-a-vyatta-appliance-attached-to-a-cloud-network
type: article
created_date: '2013-01-17 23:57:32'
created_by: sameer.satyam
last_modified_date: '2015-09-29 17:3556'
last_modified_by: kyle.laffoon
products: Cloud Servers
categories: Server Management
body_format: tinymce
---

<p>You can configure a Vyatta Appliance to act as a remote access VPN gateway so that clients can securely connect to their infrastructure in the Rackspace cloud.&nbsp;</p>

<h2><span>Introduction</span></h2>

<p><span>This article shows how to configure the Vyatta Appliance for Remote Access VPN using&nbsp;</span><span>L2TP/IPsec with Pre-Shared Keys for authentication.</span></p>

<p><span>For a comprehensive guide to VPN configuration on the Vyatta, click <a href="https://54712289bdd910def82d-5cc7866f7aae0a382278b5bce7412a4a.ssl.cf1.rackcdn.com/Vyatta-VPN_6.5R1_v01.pdf" target="_blank">here</a></span></p>

<p><span>For guidance on configuring the relevant firewall rules to allow remote-access&nbsp;</span><span>VPN</span><span>&nbsp;on the Vyatta please refer to the following article:</span></p>

<p><a href="http://www.rackspace.com/knowledge_center/article/configuring-interface-based-firewall-on-the-vyatta-network-appliance" target="_blank"><span>Configuring interface based firewall on the Vyatta network appliance</span></a></p>

<p>The VPN access using L2TP/IPsec with pre-shared key works as follows:</p>

<ol>
	<li>The remote client first establishes an IPsec tunnel with the VPN server (Vyatta).</li>
	<li>The L2TP client and server then establish an L2TP tunnel on top of the IPsec tunnel.</li>
	<li>Finally, a PPP session is established on top of the L2TP tunnel, i.e., the PPP packets are encapsulated and sent/received inside the L2TP tunnel.</li>
</ol>

<p>In the following illustration, t<span>raffic from remote access clients enters on the Public interface on the Vyatta appliance. 192.168.100.0/24, is the subnet assigned to the clients when the VPN session is established. The outside-address X.X.X.X address is the Vyatta’s Public IP address.</span></p>

<p><img alt="" border="2" height="334" src="/knowledge_center/sites/default/files/field/image/VPN%20with%20Vyatta.png" width="600" /></p>

<h2>Configure the L2TP/IPsec VPN on the Vyatta Appliance</h2>

<h3>Step 1. Set Up Vyatta as an L2TP/IPsec VPN Server</h3>

<p>In the following example eth0 is the Public interface enabled for IPsec. The pre-shared secret is "SUPERSECRET".</p>

<ol>
	<li>Log onto the Vyatta Appliance using ssh:
	<pre>
<code>ssh vyatta@X.X.X.X</code></pre>

	<p>Where X.X.X.X is the IP address of the vyatta's Public interface. You'll see a Welcome to Vyatta message and a prompt to enter your Vyatta password.</p>

	<p>Once you're logged into the appliance, you can enter a "?" or press the Tab key for help.</p>
	</li>
	<li>Enter configuration mode:
	<pre>
vyatta@vyatta: configure
[edit]
vyatta@vyatta#</pre>

	<p>The # symbol indicates you're in configuration mode.</p>
	</li>
	<li>Define the interface used for IPsec; in this case eth0 is the public interface enabled for IPsec :
	<pre>
set vpn ipsec ipsec-interfaces interface eth0</pre>
	</li>
	<li>Enable NAT traversal allowing IPSec packets to travel through NAT points in the network:
	<pre>
set vpn ipsec nat-traversal enable</pre>
	</li>
	<li>Set the remote client IP subnet from which connection is initiated. To allow clients to connect from anywhere specify 0.0.0.0/0 as the allowed-network
	<pre>
set vpn ipsec nat-networks allowed-network 0.0.0.0/0</pre>
	</li>
	<li>Commit the change:
	<pre>
vyatta@vyatta# commit
</pre>
	</li>
	<li>Save the change:
	<pre>
vyatta@vyatta# save

Saving configuration to /config/config.boot
</pre>
	</li>
	<li>Show the IPsec configuration:
	<pre>
vyatta@vyatta# show vpn ipsec
ipsec-interfaces {
interface eth0
}
nat-networks {
allowed-network 0.0.0.0/0 {
}
}
nat-traversal enable

</pre>
	</li>
</ol>

<h3>Step 2. Configure L2TP remote access address and the client pool</h3>

<ol>
	<li>Bind the L2TP server to the external address:
	<pre>
set vpn l2tp remote-access outside-address X.X.X.X</pre>

	<p>Where X.X.X.X represents the Vyatta eth0 interface IP address.</p>
	</li>
	<li>Set up the pool of IP addresses that remote VPN clients will assume.&nbsp;
	<pre>
set vpn l2tp remote-access client-ip-pool start 192.168.100.1</pre>

	<p>Where 192.168.100.10 represents the start IP address for the client pool.</p>

	<pre>
set vpn l2tp remote-access client-ip-pool stop 192.168.100.100</pre>

	<p>Where 192.168.100.100 represents the end IP address for the client pool.</p>
	</li>
</ol>

<h3>Step 3. Configure the IPsec pre-shared secret and user authentication</h3>

<ol>
	<li>
	<p>Set the IPsec authentication mode to the pre-shared secret:</p>

	<pre>
set vpn l2tp remote-access ipsec-settings authentication mode pre-shared-secret</pre>
	</li>
	<li>
	<p>Set the pre-shared secret:</p>

	<pre>
set vpn l2tp remote-access ipsec-settings authentication pre-shared-secret <strong>SUPERSECRET</strong></pre>
	</li>
	<li>
	<p>Set the L2TP remote access authentication mode to local:</p>

	<pre>
set vpn l2tp remote-access authentication mode local</pre>

	<p>This indicates that user authentication occurs locally on the Vyatta Appliance.</p>
	</li>
	<li>
	<p>Set theL2TP remote access username and password:</p>

	<pre>
set vpn l2tp remote-access authentication local-users username <strong>test</strong> password <strong>test</strong></pre>

	<p><strong>test</strong> and <strong>test</strong> represent the client username and password.</p>
	</li>
	<li>Commit the change:
	<pre>
vyatta@vyatta# commit</pre>
	</li>
	<li>Save the change:
	<pre>
vyatta@vyatta# save 
Saving configuration to /config/config.boot</pre>
	</li>
	<li>View the LT2P configuration:
	<pre>
vyatta@vyatta# show vpn l2tp remote-access
authentication {
local-users {
username test {
password test
}
}
mode local
}
client-ip-pool {
start 192.168.100.1
stop 192.168.100.100
}
ipsec-settings {
authentication {
mode pre-shared-secret
pre-shared-secret SUPERSECRET
}
}
outside-address X.X.X.X

</pre>
	</li>
</ol>

<p>&nbsp;This completes the L2TP configuration on the Vyatta Appliance. If you later want to edit the L2TP remote access configuration, enter <code>remote-access</code> while in the <code>edit</code> mode on the Vyatta Appliance.</p>

<pre>
vyatta@vyatta# edit vpn l2tp remote-access&nbsp;
[edit vpn l2tp remote-access]
vyatta@vyatta#&nbsp;</pre>

<p>The following section describes how to configure client VPN settings on the Mac and Windows clients.</p>

<h2>Mac Client Configuration</h2>

<p>For Mac clients you'll need to configure the following options:</p>

<ul>
	<li>Network Preferences</li>
	<li>Connection Details</li>
	<li>Authentication Settings</li>
</ul>

<h4>Mac Client Network Preferences</h4>

<p>Select System Preferences from the Apple menu, then click Network.</p>

<p>Select the Vyatta VPN (LT2P) network and update the following options:</p>

<p><img alt="" border="2" height="414" src="/knowledge_center/sites/default/files/field/image/MAC%20Network%20Prefs.png" width="623" /></p>

<h4>Mac Client Connection Details</h4>

<p><img alt="" border="2" height="419" src="/knowledge_center/sites/default/files/field/image/MAC%20Connection%20Details.png" width="627" /></p>

<h4>Mac Client Authentication Settings</h4>

<p><img alt="" border="2" height="419" src="/knowledge_center/sites/default/files/field/image/MAC%20Authentication%20Settings.png" width="631" /></p>

<h4>&nbsp;</h4>

<h4>Configure Split Tunnel on the Mac Native IPsec Client</h4>

<p>If you want the VPN connection to be used only to access your cloud servers, and all other traffic (internet traffic) will not use the IPsec tunnel , ensure that “Send all traffic over VPN connection” is unchecked under Options.<span>&nbsp;&nbsp;</span></p>

<p><img alt="" border="2" height="465" src="/knowledge_center/sites/default/files/field/image/MAC%20Split%20Tunnell.png" width="539" /></p>

<p>After enabling split tunnel on a MAC client, you may need to add a static route to force all traffic destined to the VPN network over the PPP interface. For example:</p>

<pre>
sudo /sbin/route add -net 192.168.x.0/24 -interface ppp0</pre>

<p><span>Where 192.168.x.0/24 is the CIDR of your Cloud Network.</span></p>

<p><span>&nbsp;</span></p>

<p>The following screenshot shows a successful connection:</p>

<p><img alt="" border="2" height="535" src="/knowledge_center/sites/default/files/field/image/MAC%20Successful%20Connection.png" width="630" /></p>

<h2>Windows Client Configuration</h2>

<p>To configure Windows clients, update the following network options.</p>

<h4>Set up a virtual private network (VPN) connection</h4>

<p><img alt="" border="2" height="527" src="/knowledge_center/sites/default/files/field/image/Windows%20Set%20Up%20VPN.png" width="523" />&nbsp;</p>

<h4>Type the Internet Address to Connect To</h4>

<p><img alt="" border="2" height="387" src="/knowledge_center/sites/default/files/field/image/Win%20Type%20the%20internet%20address%20to%20connect%20to.png" width="581" /></p>

<h4>Enter Login Credentials</h4>

<p><img alt="" border="2" height="363" src="/knowledge_center/sites/default/files/field/image/Win%20Username%20and%20Password.png" width="531" /></p>

<h4>Connect to the VPN</h4>

<p><img alt="" border="2" height="364" src="/knowledge_center/sites/default/files/field/image/Win%20The%20connection%20is%20ready.png" width="548" /></p>

<h4>Configure Vyatta VPN Properities</h4>

<p><img alt="" border="2" height="452" src="/knowledge_center/sites/default/files/field/image/Win%20Connect%20to%20a%20Network_0.png" width="712" /></p>

<h4>Configure VPN Properities General Configuration Tab</h4>

<p><img alt="" border="2" height="554" src="/knowledge_center/sites/default/files/field/image/Win%20Vyatta%20VPN%20Properties.png" width="461" /></p>

<h4>Configure VPN Security Settings Tab</h4>

<p><img alt="" border="2" height="562" src="/knowledge_center/sites/default/files/field/image/Win%20Vyatta%20VPN%20Security%20Tab.png" width="467" /></p>

<h4>Configure Advanced Properties</h4>

<h4><img alt="" border="2" height="347" src="/knowledge_center/sites/default/files/field/image/Win%20Vyatta%20Advanced%20Properites.png" width="566" /></h4>

<h4>Configure Split Tunnel on the Windows Native IPsec Client</h4>

<p>On a Windows client, by default, after the VPN configuration is created, the client is configured for Full Tunneling (all traffic flows across the VPN.) If you want to configure the client for Split Tunelling (where internet traffic does not flow across the VPN), you can modify the client VPN configuration as follows:</p>

<ol>
	<li>Select, Start, Control Panel, Network Connections.</li>
	<li>Right-click the icon for the VPN connection (Vyatta-L2TP), then click Properties.</li>
	<li>Click Advanced. Uncheck the "Use default gateway on remove network" checkbox.</li>
	<li>Click OK three times.</li>
</ol>

<h4>&nbsp;<img alt="" border="2" height="586" src="/knowledge_center/sites/default/files/field/image/Win%20Split%20Tunneling.png" width="490" /></h4>

<h4>View Client Connection</h4>

<p>Do the following to check the client's connection:</p>

<p>View the Network and Sharing Center to see client logged into Vyatta VPN.</p>

<p>Run ipconfig i<span>n a Command Prompt window to see the client's IP address.</span></p>

<p>Show the configuration on the Vyatta Appliance:</p>

<pre>
vyatta@vyatta:~$ show vpn remote-access&nbsp;
Active remote access VPN sessions:
User &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Proto Iface &nbsp; &nbsp; Tunnel IP &nbsp; &nbsp; &nbsp; TX byte RX byte &nbsp;Time&nbsp;
---- &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;----- ----- &nbsp; &nbsp; --------- &nbsp; &nbsp; &nbsp; ------- ------- &nbsp;----&nbsp;
test &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;L2TP &nbsp;l2tp0 &nbsp; &nbsp; 192.168.100.1 &nbsp; &nbsp; &nbsp;1.0K &nbsp; &nbsp;6.1K &nbsp;00h01m26s&nbsp;
&nbsp;</pre>
