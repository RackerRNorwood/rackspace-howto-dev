---
node_id: 389
title: Migrating a Linux Server From the Command Line Stage 3
permalink: article/migrating-a-linux-server-from-the-command-line-stage-3
type: article
created_date: '2011-03-16 21:57:40'
created_by: jered.heeschen
last_modified_date: '2014-11-11 16:1244'
last_modified_by: David Hendler
products: Cloud Servers
categories: Uncategorized
body_format: full_html
---

<h3 id="otherscenarios">Other scenarios</h3>

<p>In the <a href="/knowledge_center/index.php/Migrating_a_Linux_Server_From_Command_Line_Stage_2" title="Migrating a Linux server from the command line - running the sync">previous article</a> in this series we discussed using rsync to do a live migration of your system from one Linux server to another. We looked at preparing the destination environment to be similar to the source server, then set up an rsync exclude file, then performed the sync.</p>

<p>It’s not always practical to perform a live sync the way we outlined it, or you may want to migrate just a couple applications instead of the entire system. Let’s look at your options in those cases.</p>

<p>Remember that this process requires that rsync be installed on both the origin and destination servers. The package name is usually “rsync”. Use your package manager to install it if you get a “not found” response from running:</p>

<pre>
<code>which rsync
</code></pre>

<h3 id="syncingwiththeserverinactive">Syncing with the server inactive</h3>

<p>A live sync has the advantage of minimizing downtime during the migration but it can require multiple runs of rsync to complete if you have a lot of files that change frequently. After a pass or two with rsync on a live server it can be practical to perform the final sync while your origin server is not running at all.</p>

<p>It’s also possible that you may be unable to boot the source system for reasons unrelated to the installed software. In that case you’d also need to be able to access your files while the server is dormant.</p>

<p>For real (non-virtual) servers you’d copy files while keeping the server down by booting the machine from a rescue disk (usually a live CD distribution), mounting the file system, then performing the final sync from there. Fortunately there are ways to simulate that for virtual servers.</p>

<p>An approach many virtual server providers take is to provide an option to boot your server using a temporary server instance. It acts as a virtual rescue disk, allowing you to mount your server’s file system while the system isn’t running. For Rackspace Cloud Servers it’s called “rescue mode”.</p>

<h4 id="rescuemode">Rescue mode</h4>

<p>For a Cloud Server you can put the instance into rescue mode via the&nbsp;<a href="https://mycloud.rackspace.com" title="Next-Gen Cloud Control Panel">Cloud Control Panel</a>. For more information on rescue mode see <a href="/knowledge_center/node/3295" title="How to use rescue mode">this article</a>.</p>

<p>Once the server is in rescue mode remember that the SSH key for the host will have changed, so you’ll probably need to delete the server’s key from your “~/.ssh/known_hosts” file or equivalent.</p>

<p>Once you’re logged into the instance in rescue mode you should be able to mount your server’s file system and then proceed with the sync.</p>

<p>Determine your file system’s device by running:</p>

<pre>
<code>fdisk -l
</code></pre>

<p>Look for the device that matches the size of your disk. It should be the second disk listed, either “/dev/sda1”, “/dev/sdb1”, or “/dev/xvdb1”.</p>

<p>We’ll use /dev/xvdb1 for our example. To mount that filesystem onto the /mnt/origin directory, run:</p>

<pre>
<code>mkdir /mnt/origin
mount /dev/xvdb1 /mnt/origin
</code></pre>

<p>Note that rescue mode has a time limit of 90 minutes, after which your server will reboot in normal mode. If your final sync takes longer than that you may need to put the instance back into rescue mode then run the rsync command again to pick up where things left off. If you still run into trouble with the time limit talk to our support staff and they can assist you.</p>

<h3 id="rsyncingfromamountpoint">Rsyncing from a mount point</h3>

<p>After booting your server into a rescue mode and mounting your server’s file system to a mount point like “/mnt/origin” you will need to adjust your rsync command accordingly.</p>

<p>First make sure you create an exclude file and make any changes necessary for your environment as explained in the “Rsync excludes” section of <a href="/knowledge_center/index.php/Migrating_a_Linux_Server_From_Command_Line_Stage_2">this article on live server migration</a>. Create the list without mentioning the mount point stuff, just list them as they would appear in your regular file system.</p>

<p>An example exclude file would look just like one used for a live migration:</p>

<pre>
<code>/boot
/proc
/sys
/tmp
/dev
/var/lock
/etc/fstab
/etc/mtab
/etc/resolv.conf
/etc/conf.d/net
/etc/network/interfaces
/etc/networks
/etc/sysconfig/network*
/etc/sysconfig/hwconf
/etc/sysconfig/ip6tables-config
/etc/sysconfig/kernel
/etc/hostname
/etc/HOSTNAME
/etc/hosts
/etc/modprobe*
/etc/modules
/net
/lib/modules
/etc/rc.conf
/usr/share/nova-agent*
/usr/sbin/nova-agent*
/etc/init.d/nova-agent*
</code></pre>

<p>Next we’ll set up our rsync command so it takes the mount points of the file systems on both servers into account. The rsync command with the origin server in a rescue mode would be:</p>

<pre>
<code>sudo rsync -e 'ssh -p 30000' -azPx --delete-after --exclude-from="/mnt/origin/home/demo/exclude.txt" /mnt/origin/ root@1.2.3.4:/
</code></pre>

<p>Note the trailing “/” on the origin directory. Including the slash at the end makes sure rsync treats the origin and destination directories as the same relative locations, so don’t leave that part out. Otherwise you might end up with your files getting copied into a new subdirectory on the destination instead of sending the files to their proper locations.</p>

<p>As a bonus, with that trailing slash on the directories rsync will treat the exclude file list as relative to the source directory. That’s why we don’t need to change the exclude file to account for the mount point.</p>

<h4 id="bothserversinrescuemode">Both servers in rescue mode</h4>

<p>If you’re being extra careful and have both the origin and the destination in a rescue mode you would change the destination directory too. With the destination server mounted at “/mnt/destination” the rsync command would look like:</p>

<pre>
<code>sudo rsync -e 'ssh -p 30000' -azPx --delete-after --exclude-from="/mnt/origin/home/demo/exclude.txt" /mnt/origin/ root@1.2.3.4:/mnt/destination/
</code></pre>

<p>Once the final sync is done you can boot up the destination server and run your tests.</p>

<h3 id="per-packageapproaches">Per-package approaches</h3>

<p>It may be impractical to migrate your entire server, or you may only have a couple services you need to bring over. In that case you can migrate the system on a per-package basis. It might be a little more work than running a full sync but it could be faster overall.</p>

<p>In general this approach would require installing the requisite package on the destination server then copying its configuration and data files from the origin server to the appropriate place on the destination. Once you’re done start or restart the service on the destination and test to make sure everything is in its place.</p>

<p>You may need to tweak any aspects of the system you had changed on the origin server once you’ve completed the copies. If you created a logrotate config for the service (or changed it) you’ll need to copy that over. If you had a cron job set up for the service that would also need to be migrated.</p>

<p>A couple examples follow to illustrate the approach.</p>

<h4 id="webservers">Web servers</h4>

<p>If you’re migrating a web server you’ll need to make sure you bring over your configuration files (including virtual host definitions) as well as the files used by your website.</p>

<p>If you’ve been keeping your web files in a user’s home directory make sure you have that user created on the destination server. If the user name is “demo” and the web files are all in the directory “public_html” you can run an rsync command similar to the following:</p>

<pre>
<code>sudo rsync -e 'ssh -p 30000' -azPx --delete-after ~demo/public_html root@1.2.3.4:/~demo/public_html
</code></pre>

<p>We left out the “exclude-from” flag because we wouldn’t usually need to exclude any files from this sync.</p>

<p>The configuration directory for your web server may vary by distribution, particularly for apache. Ubuntu and Debian use “/etc/apache2”, CentOS and other Red Hat-based distributions use “/etc/httpd”, and so on. So first, find your config directory.</p>

<p>Once you have the configuration directory identified run an rsync command similar to the above but copying the configuration directory instead. If you’re running nginx this might look like:</p>

<pre>
<code>sudo rsync -e 'ssh -p 30000' -azPx --delete-after /etc/nginx root@1.2.3.4:/etc/nginx
</code></pre>

<p>If you’re using PHP you may also need to bring over any changes you made to your php.ini.</p>

<p>After that restart your web server and run it through some tests.</p>

<h4 id="databases">Databases</h4>

<p>A similar approach works with a database service. Install the database on the destination server, making sure you get as close to the version running on the origin as you can.</p>

<p>Bring the database service down and identify where its configuration and data files are kept. For mysql the configuration files are usually in /etc/mysql and the databases themselves are in /var/lib/mysql.</p>

<p>It’s easier to do this with two rsync commands, one for the config and one for the databases. For a mysql installation the commands might look like this:</p>

<pre>
<code>sudo rsync -e 'ssh -p 30000' -azPx --delete-after /etc/mysql root@1.2.3.4:/etc/mysql
sudo rsync -e 'ssh -p 30000' -azPx --delete-after /var/lib/mysql root@1.2.3.4:/var/lib/mysql
</code></pre>

<p>Next check to make sure there aren’t other changes you made on the origin server related to the database (like cron jobs or logrotate configuration). Then start or restart the database service on the destination and get to testing.</p>

<h3 id="speedinguprsync">Speeding up rsync</h3>

<p>If you find that your migration is taking a long time there might be further measures you can take to cut down on the work rsync has to do. For more information, see <a href="/knowledge_center/index.php/Migrating_a_Linux_Server_From_Command_Line_-Tips_For_Speeding_Up_Rsync" title="Tips for speeding up rsync">this article on speeding up rsync operations</a>.</p>

<h3 id="summary">Summary</h3>

<p>Now you should have your system migrated to another server and are enjoying the results. Congratulations! But do remember to test thoroughly before going into production with the new server. Surprises are bad (on a server, anyway).</p>
