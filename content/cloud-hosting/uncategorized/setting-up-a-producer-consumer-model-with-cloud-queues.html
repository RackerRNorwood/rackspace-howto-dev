---
node_id: 3657
title: Setting Up a Producer-Consumer Model with Cloud Queues
permalink: article/setting-up-a-producer-consumer-model-with-cloud-queues
type: article
created_date: '2013-08-21 04:01:17'
created_by: megan.meza
last_modified_date: '2013-11-13 13:4919'
last_modified_by: kyle.laffoon
products: Cloud Hosting
categories: Uncategorized
body_format: tinymce
---

<p>Setting up a Producer-Consumer model in Cloud Queues consists of posting messages to your queue, consumers claiming messages from that queue, and then deleting the completed message.&nbsp;</p><p>The producer-consumer mode has the following characteristics:</p><ul type="disc"><li>Messages are acted upon by one (and only one) worker.</li><li>Worker must delete message when done.</li><li>TTL restores message to unclaimed state if worker never finishes.</li><li>Ideal for dispatching jobs to multiple processors.</li></ul><p>This mode is ideal for dispatching jobs to multiple processors.</p><p><strong>Posting Messages to Queue</strong></p><p>Queues support posting 10 messages at the same time, so lets try to post two within the same request.</p><p><em><strong>Request</strong></em></p><pre>    $ curl -i -X POST https://$ENDPOINT:443/v1/queues/samplequeue/messages -d '     [            {"ttl": 300, "body": {"event": "two"}},         {"ttl": 60, "body": {"event": "three"}}     ]     ' -H "Content-type: application/json" -H "Client-ID: e58668fc-26eb-11e3-8270-5b3128d43830" -H "X-Auth-Token: $TOKEN"</pre><p><strong>Note: </strong>Use Claim TTLs to protect from agent/client failure while they have a message claimed.&nbsp; In the event that a server goes offline and cannot complete the message it has claimed, the claim TTL will expire and that message will be returned to the queue for other consumers or workers to claim.</p><p><em><strong>Response</strong></em></p><pre>    HTTP/1.1 201 Created     Content-Length: 153     Content-Type: application/json; charset=utf-8     Location: /v1/queues/samplequeue/messages?ids=51e840e71d10b2055fd565fb,51e840e71d10b2055fd565fc      {partial": false, "resources": ["/v1/queues/samplequeue/messages/51e840e71d10b2055fd565fb", "/v1/queues/samplequeue/messages/51e840e71d10b2055fd565fc"]}</pre><p>Above, if you check the response, you will see that the queue returned two ids. It is always a good practice to post messages in batches as network latency will be a smaller factor in overall performance compared to sending one message at a time.</p><p><strong>Claiming Messages</strong></p><p>Claiming a message is pretty much like marking a message so it will be invisible when another worker wants to claim messages. By default 10 messages are claimed. In the sample request below, we will get 2 messages claimed as we use pass 2 as limit.</p><p><strong><em>Request</em></strong></p><p>$ curl -i -X POST https://$ENDPOINT:443/v1/queues/samplequeue/claims?limit=2 -d ' { "ttl" : 60, "grace": 60} ' -H "X-Auth-Token: $TOKEN" -H "Content-type: application/json" -H "Client-ID: e58668fc-26eb-11e3-8270-5b3128d43830"</p><p><strong><em>Response</em></strong></p><p>HTTP/1.1 200 OK Content-Length: 306 Content-Type: application/json; charset=utf-8 Location: /v1/queues/samplequeue/claims/51e852d01d10b2056dd5703c [{"body": {"event": "two"}, "age": 5, "href": "/v1/queues/samplequeue/messages/51e852cb1d10b20571d56f10?claim_id=51e852d01d10b2056dd5703c", "ttl": 300}, {"body": {"event": "three"}, "age": 5, "href": "/v1/queues/samplequeue/messages/51e852cb1d10b20571d56f11?claim_id=51e852d01d10b2056dd5703c", "ttl": 120}]</p><p><strong>Deleting Completed Messages</strong></p><p><strong><em>Request</em></strong></p><p>$ curl -i -X DELETE https://$ENDPOINT:443/v1/queues/samplequeue/messages/51e852cb1d10b20571d56f10?claim_id=51e852d01d10b2056dd5703c -H "X-Auth-Token: $TOKEN" -H "Content-type: application/json" -H "Client-ID: e58668fc-26eb-11e3-8270-5b3128d43830"</p><p><strong><em>Response</em></strong></p><p>HTTP/1.1 204 No Content</p><p>204 is a valid response which validates that there isn't a message with the given message and claim id. It doesn't necessarily say that message is deleted, though.</p><p><strong>Please Note</strong> : We have additional developer information available in our API documentation. Listed under Other Products, we have a <a href="http://docs-internal.rackspace.com/queues/api/v1.0/cq-gettingstarted/content/doc-change-history.html">Getting Started Guide</a> and an <a href="http://docs-internal.rackspace.com/queues/api/v1.0/cq-devguide/content/overview.html">API Developer Guide</a> for Cloud Queues.</p>
