---
node_id: 3663
title: Using task states with server imaging
permalink: article/using-task-states-with-server-imaging
type: article
created_date: '2013-08-28 16:31:37'
created_by: brian.rosmaita
last_modified_date: '2015-06-03 17:4436'
last_modified_by: kelly.holcomb
products: Cloud Servers
categories: Server Images
body_format: tinymce
---

<p>Some new task states have been exposed in the OpenStack Server Extended Status Extension that provide more fine-grained visibility into server state during the image-create (or "snapshot") process. &nbsp;In this article, I'll tell you what they are and make some suggestions for how you can make use of them.</p>

<p>Before the OpenStack Grizzly release, when you requested a create image action on a server, the server would go into a special "task state" of image_snapshot, and it would stay in this task state until the image was completed. &nbsp;This single task state hid the fact that there are three distinct phases to a snapshot operation:</p>

<ol>
	<li>The hypervisor creates an image of the server's virtual hard disk.</li>
	<li>The hypervisor packages the image and prepares it for upload to the image store.</li>
	<li>The hypervisor uploads the packaged image to the image store.</li>
</ol>

<p>By far, the phase that takes the longest is the third phase, in which the upload occurs. &nbsp;Further, in both phases 2 and 3, while the hypervisor is working on your server's behalf, it isn't doing anything with your virtual hard disk. &nbsp;So only during phase 1 is it important that you avoid any operations that would modify data on the server's virtual hard disk. &nbsp;(Otherwise, the recorded snapshot might include inconsistencies from which certain application programs on your server--I'm thinking primarily of databases here--might not be able to recover when you boot from the image.)</p>

<p>With the OpenStack Grizzly release, the semantics of the image_snapshot task state were modified slightly and two new task states were added. &nbsp;So now the task states that your server will go through while processing an image create action are:</p>

<ol>
	<li>image_snapshot: the hypervisor is creating an image of the server's virtual hard disk</li>
	<li>image_pending_upload: the hypervisor is packaging the image and preparing it for upload</li>
	<li>image_uploading: the hypervisor is uploading the image to the image store</li>
</ol>

<p>While your server is any of these task states, you can't issue another create image action on that server. &nbsp;As you can see from the task state descriptions, the hypervisor is involved in all three phases of the image create action, so all the extra bookkeeping resources the hypervisor has allocated to your server are in use. &nbsp;You have to wait until the entire snapshot process has completed and these resources are released before you can create another snapshot.</p>

<p>Notice, however, that once the first phase is completed, you no longer have to worry about operations occuring on your server that might interfere with the effectiveness of your snapshot. &nbsp;Unfortunately, server task states are not currently exposed in the control panel. &nbsp;You can, however, easily check them by using the API or the python-novaclient.</p>

<h3>Using the API to Check Server Task State</h3>

<p>The task states are included in the server detail response:</p>

<p>GET /v2/servers/{serverId}</p>

<p>Here's an abbreviated JSON server detail response:</p>

<pre>
{
&nbsp; &nbsp; "server": {
&nbsp; &nbsp; &nbsp; &nbsp; "OS-EXT-STS:power_state": 1,
&nbsp; &nbsp; &nbsp; &nbsp; "OS-EXT-STS:task_state": "image_pending_upload",
&nbsp; &nbsp; &nbsp; &nbsp; "OS-EXT-STS:vm_state": "active",
&nbsp; &nbsp; &nbsp; &nbsp; /* ... */
&nbsp; &nbsp; &nbsp; &nbsp; "id": "c2d5da0a-80d7-4ca7-872c-505410ab55d0",
&nbsp; &nbsp; &nbsp; &nbsp; /* ... */
&nbsp; &nbsp; &nbsp; &nbsp; "name": "check-my-task-state",
&nbsp; &nbsp; &nbsp; &nbsp; "progress": 100,
&nbsp; &nbsp; &nbsp; &nbsp; "status": "ACTIVE",
&nbsp; &nbsp;}
}
</pre>

<p>You're looking for the element named "OS-EXT-STS:task_state". &nbsp;(Since a JSON object is unordered, it might not be right near the top of the response, as it is in this example.)&nbsp; From the value displayed in this example, you can see that the hypervisor has completed creating the image of the server's virtual hard disk and is now packaging and preparing the image for upload.</p>

<h3>Using the Python-Novaclient to Check Server Task State</h3>

<p>The python-novaclient is a handy program you can run from the command line. &nbsp;If you haven't used it before, here are some Knowledge Center articles to check out:</p>

<ul>
	<li><a href="http://www.rackspace.com/knowledge_center/article/installing-python-novaclient-on-linux-and-mac-os" target="_blank">Installing python-novaclient on Linux and Mac OS</a></li>
	<li><a href="http://www.rackspace.com/knowledge_center/article/installing-python-novaclient-on-windows" target="_blank">Installing python-novaclient on Windows</a></li>
</ul>

<p>These articles will provide you with an overview of python-novaclient and complete instructions for installing it on your operating system of choice.</p>

<p>To see the task state for a server using the python-novaclient, simply do a "show" on the server:</p>

<p>$ nova show {serverId}</p>

<p>Here's an abbreviated response:</p>

<pre>
+------------------------+---------------------------------------+
| Property               | Value                                 |
+------------------------+---------------------------------------+
| status                 | ACTIVE                                |
| OS-EXT-STS:task_state  | None                                  |
| OS-EXT-STS:vm_state    | active                                |
| id                     | 933e803f-13b0-4698-a5c7-f74ec424fd38  |
| name                   | check-my-task-state                   |
| OS-DCF:diskConfig      | MANUAL                                |
| progress               | 100                                   |
| OS-EXT-STS:power_state | 1                                     |
| metadata               | {}                                    |
+------------------------+---------------------------------------+
</pre>

<p>In this example, you can see that there's no task state for the server, so it could accept an image-create request.</p>

<p><span>&nbsp;</span></p>

<h3>Polling to Check Server Task State</h3>

<p><span>The use case for server task states we're discussing here is the ability to:</span></p>

<ol>
	<li><span><span>Stop activities on the server that would affect the quality of the disk image (e.g., stop a database management system).</span></span></li>
	<li><span><span>Issue an image-create command (via API, novaclient, or control panel) for the server.</span></span></li>
	<li><span><span>Monitor the server to see when it exits the 'image_snapshot' task state.</span></span></li>
	<li><span><span>Restart the activities stopped before you took the snapshot (e.g., bring your database management system back up).</span></span></li>
</ol>

<p><span><span>You can write a simple bash script to monitor your server. &nbsp;How elaborate you want the script to be is up to you, here's a sample of the most relevant part. &nbsp;(Please read through and make sure you know what it's doing before using it.)&nbsp; It uses four programs (curl, egrep, sed, and date) that are installed by default on most linux systems.&nbsp; This fragment is pretty primitive, you have to control-C to stop the script.</span></span></p>

<pre>
# set these vars
#
# the API endpoint, e.g., "https://iad.servers.api.rackspacecloud.com/v2/123456"
API_ENDPOINT=
# your API username, e.g., "fredco"
API_USER=
# your API auth token, obtained from the Rackspace cloud identity service
API_AUTH_TOKEN=
# the UUID of the server you want to monitor
API_SERVER=
# how long to pause in between requests, in seconds
SLEEP_TIME=30
# a temporary file, e.g., "/tmp/polling.json"
DETAIL_FIL=

# verify that the server exists
API_RESP_CODE=$(curl -X GET \
 -k -s \
 -H "X-Auth-User: $API_USER" \
 -H "X-Auth-Token: $API_AUTH_TOKEN" \
 -H "Accept: application/json" \
 -w "%{http_code}" \
 -o $DETAIL_FIL \
 "$API_ENDPOINT/servers/$API_SERVER")
if [ "$API_RESP_CODE" != "200" ] ; then
  echo "[error] can't find server $API_SERVER"
  exit 1
fi

while [ 0 ] ; do
   API_RESP_CODE=$(curl -s -k -X GET \
    -H "X-Auth-User: $API_USER" \
    -H "X-Auth-Token: $API_AUTH_TOKEN" \
    -H "Accept: application/json" \
    -w "%{http_code}" \
    -o $DETAIL_FIL \
  "$API_ENDPOINT/servers/$API_SERVER")
  if [ "$API_RESP_CODE" == "404" ] ; then
    echo "[info] server $API_SERVER has disappeared!"
    break
  fi
  RAW_STAT=$(egrep -o '"status": (".*?"|null)' $DETAIL_FIL | sed 's/"//g')
  VM_STAT=$(egrep -o '"OS-EXT-STS:vm_state": (".*?"|null)' $DETAIL_FIL | sed 's/OS-EXT-STS://;s/"//g')
  TASK_STAT=$(egrep -o '"OS-EXT-STS:task_state": (".*?"|null)' $DETAIL_FIL | sed 's/OS-EXT-STS://;s/"//g')
  POW_STAT=$(egrep -o '"OS-EXT-STS:power_state": (\d|null)' $DETAIL_FIL | sed 's/OS-EXT-STS://;s/"//g')
  TIME=$(date +"%H:%M:%S")
  echo "$TIME   $RAW_STAT   $VM_STAT   $TASK_STAT   $POW_STAT"
  sleep ${SLEEP_TIME:-45}
done
</pre>

<p>If you start a script that contains the above fragment and then take a server snapshot, you'll see something like this:</p>

<pre>
17:14:41   status: ACTIVE   vm_state: active   task_state: null   power_state: 1
17:14:44   status: ACTIVE   vm_state: active   task_state: null   power_state: 1
17:14:48   status: ACTIVE   vm_state: active   task_state: image_snapshot   power_state: 1
17:14:51   status: ACTIVE   vm_state: active   task_state: image_pending_upload   power_state: 1
17:14:55   status: ACTIVE   vm_state: active   task_state: image_pending_upload   power_state: 1
17:14:58   status: ACTIVE   vm_state: active   task_state: image_pending_upload   power_state: 1
17:15:02   status: ACTIVE   vm_state: active   task_state: image_pending_upload   power_state: 1
17:15:05   status: ACTIVE   vm_state: active   task_state: image_uploading   power_state: 1
17:15:09   status: ACTIVE   vm_state: active   task_state: image_uploading   power_state: 1
    ...
17:16:19   status: ACTIVE   vm_state: active   task_state: image_uploading   power_state: 1
17:16:23   status: ACTIVE   vm_state: active   task_state: image_uploading   power_state: 1
17:16:26   status: ACTIVE   vm_state: active   task_state: null   power_state: 1
17:16:30   status: ACTIVE   vm_state: active   task_state: null   power_state: 1
</pre>
