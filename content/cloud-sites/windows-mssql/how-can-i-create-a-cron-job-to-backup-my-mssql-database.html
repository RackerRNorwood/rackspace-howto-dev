---
node_id: 557
title: Create a cron job to back up a Cloud Sites SQL Server database
permalink: article/how-can-i-create-a-cron-job-to-backup-my-mssql-database
type: article
created_date: '2011-03-16 21:57:40'
created_by: matt.costello
last_modified_date: '2015-03-30 19:3316'
last_modified_by: kelly.holcomb
products: Cloud Sites
categories: Windows MSSQL
body_format: tinymce
---

<p><strong>Note:</strong> This article is written for the <a href="https://manage.rackspacecloud.com">Cloud Sites Control Panel</a>. You can access this interface from the <a href="https://mycloud.rackspace.com">Cloud Control Panel</a> by clicking the <strong>Cloud Control Panel</strong> menu at the top of the window and selecting <strong>Cloud Sites</strong>.</p>

<p>Microsoft SQL Server has a built-in backup feature that you can run as a query or a stored procedure. You can configure the output file to write to an FTP folder. This tutorial explains how to accomplish this task by performing the following steps:</p>

<ol>
	<li><a href="#createfolder">Create the folder where backups will be deposited</a></li>
	<li><a href="#createsp">Create a backup stored procedure in SQL Server</a></li>
	<li><a href="#createpage">Create the web page that runs the stored procedure</a></li>
	<li><a href="#createcron">Schedule the task to run every day</a></li>
</ol>

<p><strong>Note:</strong> The scripts in this tutorial were created by one of our forum users. If you need further assistance, contact your developer.</p>

<h2 id="createfolder">Create the folder</h2>

<p>First, you need to create a folder to store the backup in your FTP application.</p>

<ol>
	<li>Connect your FTP client to the account that has the database that you want to back up.</li>
	<li>Create a folder called <strong>backups</strong> inside the <strong>/web</strong> directory. The path to the folder should look similar to the following example:
	<pre>
/123456/www.domain.com/web/backups/</pre>
	</li>
	<li>In your FTP application, right-click the folder that you just created and set its permissions to <strong>766</strong>. Be aware that you are allowing all users write permissions for the folder). If your FTP client doesn't allow this, we recommend that you use a client that does, such as FileZilla, CoffeeCup FTP, or FireFTP (a Firefox plugin).</li>
</ol>

<p><strong>IMPORTANT:</strong> For this specific example to work, the permissions on the <strong>/www.domain.com</strong> and <strong>/web</strong> folders must be set to <strong>751</strong>.</p>

<h2 id="createsp">Create the stored procedure</h2>

<p>You will also need to create a stored procedure that performs the backup with an input parameter for the file name.</p>

<p>To do so, connect to your SQL Server database by using the client of your choice, and run a query similar to the following one. In this example, the stored procedure is named <code>FullBackup</code>.</p>

<pre>
set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[FullBackup]
 @FileName nvarchar(256)
AS
BEGIN

SET NOCOUNT ON;

    BACKUP DATABASE [123456_YourDatabase] TO DISK = @FileName WITH COPY_ONLY, NOFORMAT, NOINIT, NAME = N'Full Database Backup', SKIP, NOREWIND, NOUNLOAD, STATS = 10

END
</pre>

<h2 id="createpage">Create the web page</h2>

<p>Next, you create a web page that has code to execute the stored procedure. You can use any language we support on Windows, such as ASP Classic or ASP.NET. For this task, we recommend ASP Classic, so that there is no <strong>.dll</strong> file and no application restart is needed.</p>

<p>Create a new ASP page and call it <strong>backupdb.asp</strong>. Edit the location path and SQL connection string. The contents of the file are as follows:</p>

<pre>
&lt;%@LANGUAGE="VBScript" CODEPAGE="65001"%&gt;
&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"&gt;

&lt;html xmlns="http://www.w3.org/1999/xhtml"&gt;
&lt;head&gt;
&lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8" /&gt;
&lt;title&gt;Untitled Document&lt;/title&gt;

&lt;/head&gt;

&lt;body&gt;

&lt;%
    dim thismonth, thisday, thisyear, location, filename, ver, extention, abolutepath

thismonth= datepart("m", now())
thisday=datepart("d", now())
thisyear=datepart("yyyy",now())

location="\\fs1-n03\stor1wc1dfw\838249\2382489\www.yoursite.com\backups\"
filename="dbBackup-" &amp; thismonth &amp; "-" &amp; thisday &amp; "-" &amp; thisyear &amp; "_"

ver=1
extention=".bak"

absolutepath=location &amp; filename &amp; ver &amp; extention

    set fso = Server.CreateObject("Scripting.FileSystemObject")

while (fso.FileExists(absolutepath)=True)
ver=ver+1
absolutepath=location &amp; filename &amp; ver &amp; extention
wend

'pre Create the file
Dim fs,f
Set fs=Server.CreateObject("Scripting.FileSystemObject")
Set f=fs.CreateTextFile(absolutepath)
set f=nothing
set fs=nothing
'finished creating the file

    Set cn = Server.CreateObject("ADODB.Connection")
    cn.connectionString= "Provider=SQLOLEDB;Server=mssql12xx.wc1;Database=123456_YourDatabase;Uid=123456_YourUsername; Pwd=Yourpassword;"

   cn.open

   Set cmd = Server.CreateObject("ADODB.Command")
   Set cmd.ActiveConnection = cn
   cmd.CommandText = "FullBackup"
   cmd.CommandType = 4 'adCmdStoredProc

   cmd.Parameters.Refresh
   cmd.Parameters(1) = absolutepath

   cmd.Execute

   cn.close

%&gt;

   Execution complete:  Filename=&lt;%= filename &amp; ver &amp; extention%&gt;

&lt;/body&gt;
&lt;/html&gt;</pre>

<h2 id="createcron">Schedule the cron job</h2>

<p>Schedule a cron job to call the web page.</p>

<ol>
	<li>Open the Cloud Sites Control Panel.</li>
	<li>Click on the site with the database, and go to the <strong>Features</strong> tab.</li>
	<li>Under <strong>Scheduled Tasks (Cron Jobs)</strong>, click <strong>Add New Task</strong>.</li>
	<li>Specify a name for the job.</li>
	<li>Select the <strong>Send me an email</strong> check box and enter your email address.</li>
	<li>Select <strong>http</strong> as the script language.</li>
	<li>Enter the URL to the ASP script.</li>
	<li>Schedule the job to run daily at an off hour. Usually this is a late-night period, such as 1:00 a.m., when most sites experience less traffic.</li>
</ol>
