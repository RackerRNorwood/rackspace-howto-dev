---
node_id: 3370
title: Configuring Interface Based Firewall on the Vyatta Network Appliance
permalink: article/configuring-interface-based-firewall-on-the-vyatta-network-appliance
type: article
created_date: '2013-03-26 06:47:48'
created_by: sameer.satyam
last_modified_date: '2015-09-29 17:4016'
last_modified_by: kyle.laffoon
products: Cloud Servers
categories: Security
body_format: tinymce
---

<h2>Introduction</h2>

<p>The Vyatta network appliance can be used as a firewall to protect Rackspace Cloud Server instances.</p>

<p>In this article you will see how interface-based firewalls can be configured on the Vyatta and applied on the Public interface for local traffic (terminating on the Vyatta) as well as for ingress traffic (traversing the appliance and destined to Cloud Servers).</p>

<p>For a comprehensive guide to configuring the Vyatta appliance as a firewall click <a href="https://54712289bdd910def82d-5cc7866f7aae0a382278b5bce7412a4a.ssl.cf1.rackcdn.com/Vyatta-Firewall_6.5R1_v01.pdf" target="_blank">here</a> .</p>

<p>The Vyatta firewall features both IPv4 and IPv6 stateful packet inspection to&nbsp;intercept and inspect network activity and allow or deny the attempt.&nbsp;Vyatta's firewall functionality analyzes and filters IP packets between network interfaces.&nbsp;It allows you to filter packets based on their characteristics&nbsp;and perform actions on packets that match the rule. Vyatta system firewall&nbsp;functionality provides the following:</p>

<ul>
	<li>Packet filtering for traffic traversing the appliance and for traffic&nbsp;destined for the appliance itself</li>
	<li>Definable criteria for packet-matching rules, including source IP address,&nbsp;destination IP address, source port, destination port, IP protocol, and ICMP type</li>
	<li>General detection on IP options such as source routing and broadcast packets</li>
	<li>Ability to set the firewall globally for stateful or stateless operation</li>
</ul>

<p>Vyatta’s advanced&nbsp;firewall capabilities include stateful failover, zone-based firewalling and&nbsp;time-based firewalling.</p>

<h2>Firewall definition</h2>

<p>Firewalls filter packets on interfaces. There are two steps for using the firewall&nbsp;feature:</p>

<ul>
	<li>You define a firewall instance and save it under a name. A firewall instance is also&nbsp;called a firewall rule set, where a rule set is just a series of firewall rules. You&nbsp;define the firewall instance and configure the rules in its rule set in the firewall&nbsp;configuration node.</li>
	<li>After defining the instance and specifying the rules in the rule set, you apply the&nbsp;instance to an interface or a zone. You do this by configuring the interface&nbsp;configuration node for the interface or zone.</li>
</ul>

<p>Once the instance is applied to the interface or zone, the rules in the instance begin&nbsp;filtering packets on that location.</p>

<h2>Types of firewall</h2>

<p>There are two types of firewall, Interface-based firewall and zone-based firewall. If only one interface is being protected then interface-based firewall can serve your purpose. However, if more than one interface is being protected, then zone-based firewalls are recommended.</p>

<h2>Firewall rules</h2>

<p>Rules are executed in sequence according to the rule number. If the traffic matches&nbsp;the characteristics specified by the rule, the rule’s action is executed; if not, the system&nbsp;“falls through” to the next rule.</p>

<p>The action can be one of the following:</p>

<ul>
	<li>Accept. Traffic is allowed and forwarded.</li>
	<li>Drop. Traffic is silently discarded.</li>
	<li>Reject. Traffic is discarded with an ICMP “Port Unreachable” message.</li>
</ul>

<h2>Applying firewall rules to interfaces (interface-based firewall)</h2>

<p>Once a firewall instance is defined it can be applied to an interface, where the&nbsp;instance acts as a packet filter. The firewall instance filters packets in one of the&nbsp;following ways, depending on what you specify when you apply the firewall&nbsp;instance:</p>

<ul>
	<li>in. If you apply the instance as in, the firewall will filter packets entering the&nbsp;interface and traversing the Vyatta system. You can apply one in packet filter.</li>
	<li>out. If you apply the instance as out, the firewall will filter packets leaving the&nbsp;interface. These can be packets traversing the Vyatta system or packets originated&nbsp;on the system. You can apply one out packet filter.</li>
	<li>local. If you apply the instance as local, the firewall will filter packets destined&nbsp;for the Vyatta system. One firewall instance can be applied as a local packet filter.</li>
</ul>

<p>A total of three firewall instances can be applied to an interface: one instance as an&nbsp;in filter, one instance as an out filter, and one instance as a local filter.</p>

<h2>Interface-based firewall on the Public interface.</h2>

<p>The following example shows a firewall rule set applied on a Public interface of the Vyatta. This rule set does the following:</p>

<ul>
	<li>Makes the firewall stateful (global configuration). Sets recommended global rules to be applied to all firewall interfaces (in this case Public interface. Any other interfaces with a firewall configuration will also inherit this configuration)</li>
	<li>Allows L2TP over IPsec traffic for remote-access VPN sessions</li>
	<li>Allows Site-to-site VPN tunnel traffic</li>
	<li>Allows SSH and ICMP traffic</li>
</ul>

<p>&nbsp;</p>

<p><span>1. Log onto the Vyatta Appliance using ssh:</span></p>

<pre>
ssh vyatta@X.X.X.X</pre>

<p>Where X.X.X.X is the IP address of the Vyatta. You'll see a Welcome to Vyatta message and a prompt to enter your Vyatta password.</p>

<p>Once you're logged onto the appliance, you can enter a ? or press the Tab key for help.</p>

<p><span>2. Enter configuration mode:</span></p>

<pre>
vyatta@vyatta: configure
[edit]
vyatta@vyatta#</pre>

<p>The # symbol indicates you're in configuration mode.</p>

<p>&nbsp;</p>

<p>3. Make the firewall stateful (global configuration)</p>

<pre>
set firewall state-policy established action 'accept'
set firewall state-policy related action 'accept'</pre>

<p>4. Set the recommended global rules which will apply to all firewall protected interfaces. Anything global can be changed within the interface specific firewall rule</p>

<pre>
set firewall all-ping 'enable'
set firewall broadcast-ping 'disable'
set firewall ipv6-receive-redirects 'disable'
set firewall ipv6-src-route 'disable'
set firewall ip-src-route 'disable'
set firewall log-martians 'enable'
set firewall receive-redirects 'disable'
set firewall send-redirects 'enable'
set firewall source-validation 'disable'
set firewall syn-cookies 'enable'</pre>

<p>5. Start configuring firewall configuration for Public interface</p>

<pre>
edit firewall name protect-vyatta</pre>

<p>Drop everything by default</p>

<pre>
set default-action 'drop'</pre>

<p>Allow IKE and ESP traffic for IPsec</p>

<pre>
set rule 100 action 'accept'
set rule 100 destination port '500'
set rule 100 protocol 'udp'
set rule 200 action 'accept'
set rule 200 protocol 'esp'</pre>

<p>Allow L2TP over IPsec</p>

<pre>
set rule 210 action 'accept'
set rule 210 destination port '1701'
set rule 210 ipsec 'match-ipsec'
set rule 210 protocol 'udp'</pre>

<p>Allow NAT traversal of IPsec</p>

<pre>
set rule 250 action 'accept'
set rule 250 destination port '4500'
set rule 250 protocol 'udp'</pre>

<p>Deter ssh brute-force (only allow 3 new connections within 30 seconds)</p>

<pre>
set rule 300 action 'drop'
set rule 300 destination port '22'
set rule 300 protocol 'tcp'
set rule 300 recent count '3'
set rule 300 recent time '30'
set rule 300 state new 'enable'</pre>

<p>Allow all other ssh</p>

<pre>
set rule 310 action 'accept'
set rule 310 destination port '22'
set rule 310 protocol 'tcp'</pre>

<p>Allow icmp</p>

<pre>
set rule 900 action 'accept'
set rule 900 description 'allow icmp'
set rule 900 protocol 'icmp'&nbsp;
exit</pre>

<p>6. Apply locally on Public interface (eth0)</p>

<pre>
set interfaces ethernet eth0 firewall local name 'protect-vyatta'
</pre>

<p>7. Create and apply firewall ruleset 'in' (for traffic destined for cloud servers) on Public interface (eth0)</p>

<pre>
set firewall name untrusted default-action 'drop'
set firewall name untrusted description 'deny traffic from internet'
set interfaces&nbsp;ethernet&nbsp;eth0 firewall in name 'untrusted'</pre>

<p>8. Commit and save the changes.</p>

<pre>
commit
save</pre>
