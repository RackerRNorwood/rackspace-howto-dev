---
node_id: 479
title: Ubuntu - Mongrel and mongrel cluster installation
permalink: article/ubuntu-hardy-mongrel-and-mongrel-cluster-installation
type: article
created_date: '2011-03-16 21:57:40'
created_by: RackKCAdmin
last_modified_date: '2014-09-04 19:5539'
last_modified_by: kyle.laffoon
products: Cloud Servers
categories: Ruby on Rails
body_format: tinymce
---

<p>There are variety of options open to the sysadmin when serving Ruby applications.</p>
<p>One of the original ways is to use <a class="external text" title="http://mongrel.rubyforge.org/" href="http://mongrel.rubyforge.org/" rel="nofollow">mongrel web server</a>. Requests are proxied to the mongrel(s) from the main web server (Apache, Nginx, etc).</p>
<hr />
<p>The article may seem quite lengthy but two subjects are tackled here. One is the basic mongrel gem itself but then we move onto the mongrel_cluster gem.</p>
<p>Take each section at a time as each one builds on the previous explanation.</p>
<table id="toc" class="toc" summary="Contents">
<tbody>
<tr>
<td>
<div id="toctitle">
<h2>Contents</h2>
</div>
<ul>
<li class="toclevel-1"><a href="#Prerequisites"><span class="tocnumber">1</span> <span class="toctext">Prerequisites</span></a></li>
<li class="toclevel-1"><a href="#Installation"><span class="tocnumber">2</span> <span class="toctext">Installation</span></a></li>
<li class="toclevel-1"><a href="#Mongrel_basics"><span class="tocnumber">3</span> <span class="toctext">Mongrel basics</span></a></li>
<li class="toclevel-1"><a href="#Mongrel_Clusters"><span class="tocnumber">4</span> <span class="toctext">Mongrel Clusters</span></a>
<ul>
<li class="toclevel-2"><a href="#Installation_2"><span class="tocnumber">4.1</span> <span class="toctext">Installation</span></a></li>
<li class="toclevel-2"><a href="#Configuration"><span class="tocnumber">4.2</span> <span class="toctext">Configuration</span></a></li>
</ul>
</li>
<li class="toclevel-1"><a href="#YAML"><span class="tocnumber">5</span> <span class="toctext">YAML</span></a></li>
<li class="toclevel-1"><a href="#Mongrel_cluster_basics"><span class="tocnumber">6</span> <span class="toctext">Mongrel_cluster basics</span></a></li>
<li class="toclevel-1"><a href="#init_scripts"><span class="tocnumber">7</span> <span class="toctext">init scripts</span></a></li>
<li class="toclevel-1"><a href="#Cluster_control"><span class="tocnumber">8</span> <span class="toctext">Cluster control</span></a></li>
<li class="toclevel-1"><a href="#Summary"><span class="tocnumber">9</span> <span class="toctext">Summary</span></a></li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><a id="Prerequisites" name="Prerequisites"></a></p>
<h2><span class="mw-headline">Prerequisites </span></h2>
<p>I am assuming you have Ruby and Rubygems installed on your Cloud Server. If you don't, please see the <a title="Ubuntu Hardy - Ruby on Rails" href="/knowledge_center/index.php/Ubuntu_Hardy_-_Ruby_on_Rails">Ubuntu - Ruby on Rails</a> article).</p>
<p><a id="Installation" name="Installation"></a></p>
<h2><span class="mw-headline">Installation </span></h2>
<p>Mongrel is a rubygem and installation is as simple as:</p>
<pre>sudo gem instal mongrel
</pre>
<p>On the test Cloud Server with a basic rubygems and Rails installation, the process installed the following gems:</p>
<pre>gem_plugin-0.2.3
daemons-1.0.10
fastthread-1.0.1
cgi_multipart_eof_fix-2.5.0
mongrel-1.1.4
</pre>
<p>That can vary depending on what you already have installed.</p>
<p><a id="Mongrel_basics" name="Mongrel_basics"></a></p>
<h2><span class="mw-headline">Mongrel basics </span></h2>
<p>The mongrel package has 3 main commands: start, stop and restart.</p>
<p>However, there are many options you could add to fit your needs such as the environment or the port and so on:</p>
<pre>mongrel_rails start -e production -p 6000
</pre>
<p>You need to be in the rails application directory to issue that command and, perhaps obviously, it would start a mongrel instance in production mode on port 6000.</p>
<p>If you don't run it in the background (daemonised) then the output in the terminal will be similar to when using the inbuilt rails webbrick server.</p>
<p>To run it in the backgroud, simply add the '-d' option:</p>
<pre>mongrel_rails start -e production -p 6000 -d
</pre>
<p>To stop the running process (assuming it is being run in a daemonised fashion):</p>
<pre>mongrel_rails stop
</pre>
<p>Again, the command should be given when in the rails directory.</p>
<p><a id="Mongrel_Clusters" name="Mongrel_Clusters"></a></p>
<h2><span class="mw-headline">Mongrel Clusters </span></h2>
<p>You can run as many individual mongrels as you like for your application but it does get a little unwieldy if you have more than one application.</p>
<p>One solution is to create what are called mongrel clusters. These 'clusters' are predefined groups of mongrels which are easy to start and stop, etc as a cluster and be configured to start on a Cloud Server reboot (so your application will start itself on a reboot).</p>
<p><a id="Installation_2" name="Installation_2"></a></p>
<h3><span class="mw-headline">Installation </span></h3>
<p>Just as with the original mongrel install, the mongrel_cluster is a rubygem:</p>
<pre>sudo gem install mongrel_cluster
</pre>
<p>As I had already installed the mongrel gem with its dependencies, only the mongrel_cluster gem itself was installed. This may vary on your Cloud Server, depending on what you already have installed.</p>
<p><a id="Configuration" name="Configuration"></a></p>
<h3><span class="mw-headline">Configuration </span></h3>
<p>Configuring a mongrel cluster for your rails application runs along similar lines to the single mongrel options shown above.</p>
<p>To start a cluster of 2 mongrels in production mode starting from port 8000 would be as follows:</p>
<pre>mongrel_rails cluster::configure -e production -p 8000 -N 2 -c /home/demo/public_html/testapp -a 127.0.0.1
</pre>
<p>Note that I set the full path of the rails application and set the port to bind to (localhost in this case).</p>
<p>There are plenty of option available when configuring a mongrel cluster and the easiest thing is to have a look at the help file:</p>
<pre>mongrel_rails cluster::configure -h
</pre>
<p><a id="YAML" name="YAML"></a></p>
<h2><span class="mw-headline">YAML </span></h2>
<p>You will have noticed the output of the command is as follows:</p>
<pre>Writing configuration file to config/mongrel_cluster.yml.
</pre>
<p>The contents of which are:</p>
<pre>cwd: /home/demo/public_html/testapp
log_file: log/mongrel.log
port: "8000"
environment: production
address: 127.0.0.1
pid_file: tmp/pids/mongrel.pid
servers: 2
</pre>
<p>Well, no real surprises there, it simply puts the mongrel cluster options into a YAML format.</p>
<p>You can edit the file by hand if you wish to change something and don't want to go through the configure command again.</p>
<p><a id="Mongrel_cluster_basics" name="Mongrel_cluster_basics"></a></p>
<h2><span class="mw-headline">Mongrel_cluster basics </span></h2>
<p>Starting the cluster is a case of:</p>
<pre>mongrel_rails cluster::start
</pre>
<p>Ensure you are in your rails application folder when you issue the command.</p>
<p>Stopping and restarting:</p>
<pre>mongrel_rails cluster::restart
...
mongrel_rails cluster::stop

</pre>
<p><a id="init_scripts" name="init_scripts"></a></p>
<h2><span class="mw-headline">init scripts </span></h2>
<p>The final configuration you may want to consider (and I recommend it) is to create an init script so the mongrel cluster is started on a reboot.</p>
<p>Unlike 'thin' or mod_rails there is no easy way of doing this so it does require a some work.</p>
<p>Firstly, create a folder in the /etc folder:</p>
<pre>sudo mkdir /etc/mongrel_cluster
</pre>
<p>Then create a symlink from the cluster configuration file to the newly created folder:</p>
<pre>sudo ln -s /home/demo/public_html/testapp/config/mongrel_cluster.yml /etc/mongrel_cluster/testapp.yml
</pre>
<p>You will have to do that for each and every mongrel_cluster you create (if you want them to start automatically). So if you have two rails applications, you will have two symlinks.</p>
<p>Next, copy the gem init script to the init.d directory:</p>
<pre>sudo cp /usr/lib/ruby/gems/1.8/gems/mongrel_cluster-1.0.5/resources/mongrel_cluster /etc/init.d/
</pre>
<p>Make it executable:</p>
<pre>sudo chmod +x /etc/init.d/mongrel_cluster
</pre>
<p>and then add the script to the runlevels:</p>
<pre>sudo /usr/sbin/update-rc.d -f mongrel_cluster defaults
</pre>
<p>Wow. Quite a long and complicated procedure when compared to using 'thin' or mod_rails.</p>
<p><a id="Cluster_control" name="Cluster_control"></a></p>
<h2><span class="mw-headline">Cluster control </span></h2>
<p>Let's take a quick look at controlling the clusters.</p>
<p>Getting a status of any running clusters is always nice:</p>
<pre>mongrel_cluster_ctl status
</pre>
<p>The output will show something along the lines of:</p>
<pre>Checking all mongrel_clusters...
mongrel_rails cluster::status -C testapp.yml
found pid_file: tmp/pids/mongrel.8000.pid
found mongrel_rails: port 8000, pid 2343

found pid_file: tmp/pids/mongrel.8001.pid
found mongrel_rails: port 8001, pid 2346
</pre>
<p>That matches the cluster we created earlier so no problems.</p>
<p>To start/stop/restart the cluster(s):</p>
<pre>mongrel_cluster_ctl start
...
mongrel_cluster_ctl stop
...
mongrel_cluster_ctl restart
</pre>
<p>Remember you may need to put a sudo in front of the 'stop' command if you have just rebooted as the process started on reboot is owned by root.</p>
<p><a id="Summary" name="Summary"></a></p>
<h2><span class="mw-headline">Summary </span></h2>
<p>There is a lot happening in this article but when followed all the way through, we have all the necessary gems and information to create mongrel clusters for each of our rails applications.</p>
<p>A simple symlink is then all it takes to ensure the cluster is restarted on a reboot.</p>
