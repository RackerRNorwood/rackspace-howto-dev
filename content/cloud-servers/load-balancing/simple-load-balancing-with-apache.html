---
node_id: 105
title: Simple Load Balancing with Apache
permalink: article/simple-load-balancing-with-apache
type: article
created_date: '2011-03-09 19:22:30'
created_by: RackKCAdmin
last_modified_date: '2015-10-28 15:3429'
last_modified_by: kyle.laffoon
products: Cloud Servers
categories: Load Balancing
body_format: tinymce
---

<address><strong>Note:&nbsp;</strong>This article was written before the introduction of <a href="http://www.rackspace.com/knowledge_center/getting-started/cloud-load-balancers">Cloud Load Balancers</a>, which is our recommended solution for Load balancing, but customers may still wish to try this procedure so we have left it available for legacy support purposes.</address>

<p>This article will go through creating a simple software&nbsp;<a href="http://www.rackspace.com/cloud/load-balancing/">Load Balancer</a>&nbsp;using a&nbsp;<a href="http://www.rackspace.com/cloud/servers/">Cloud Server</a>.</p>

<p>We'll take this as an entry level job using simple readily available packages from any of the Distributions repositories. We'll be using Apache as our Load Balancer (yes, apache can be used for so many things, and yes it is a Load Balancer) in conjunction with the apache module mod_proxy and mod_proxy_balancer. Both are available through CentOS and I'll be using this as my base install.</p>

<p>The main thing that I want you to take out of this is that you can use Cloud Servers to scale horizontally. This is when you need horizontal expansion, add drone servers behind a smart host each working a piece of workload.</p>

<hr />
<table class="toc" id="toc" summary="Contents">
	<tbody>
		<tr>
			<td>
			<div id="toctitle">
			<h2>Contents</h2>
			</div>

			<ul>
				<li class="toclevel-1"><a href="#Prerequisites">1 Prerequisites</a>

				<ul>
					<li class="toclevel-2"><a href="#Hardware">1.1 Hardware</a></li>
					<li class="toclevel-2"><a href="#Software">1.2 Software</a></li>
				</ul>
				</li>
				<li class="toclevel-1"><a href="#Server_Configuration">2 Server Configuration</a>
				<ul>
					<li class="toclevel-2"><a href="#Web_Servers">2.1 Web Servers</a></li>
					<li class="toclevel-2"><a href="#Load_Balancer">2.2 Load Balancer</a>
					<ul>
						<li class="toclevel-3"><a href="#Unwanted_Requests">2.2.1 Unwanted Requests</a></li>
						<li class="toclevel-3"><a href="#The_Balance">2.2.2 The Balance</a></li>
						<li class="toclevel-3"><a href="#Balance_Manager">2.2.3 Balance Manager</a></li>
						<li class="toclevel-3"><a href="#ProxyPass">2.2.4 ProxyPass</a></li>
					</ul>
					</li>
				</ul>
				</li>
				<li class="toclevel-1"><a href="#Summary">3 Summary</a></li>
			</ul>
			</td>
		</tr>
	</tbody>
</table>

<p><a id="Prerequisites" name="Prerequisites"></a></p>

<h2>Prerequisites</h2>

<p><a id="Hardware" name="Hardware"></a></p>

<h3>Hardware</h3>

<p>We are going to use a total of 3 boxes to start out with, but you can use this as a model to scale horizontally.</p>

<ul>
	<li>One Cloud Server to be used as the load balancer</li>
	<li>Two Cloud Servers to be used as dumb web heads</li>
</ul>

<p><a id="Software" name="Software"></a></p>

<h3>Software</h3>

<p>The software for all three servers will be the same, technically they will be running the same packages. We'll through in only two software groups:</p>

<ul>
	<li>Update your system to all the newest goodies:</li>
</ul>

<pre>
# yum update
</pre>

<ul>
	<li>Apache and all its goodies, CentOS makes this ultra simple with the groupinstall feature:</li>
</ul>

<pre>
# yum groupinstall "Web Server"

</pre>

<ul>
	<li>Also, we are going to install links a text based web browser in case we ever need to check that a particular web head is displaying the page it is supposed to behind the load balancer. This is optional.</li>
</ul>

<pre>
# yum groupinstall "Text-based Internet"
</pre>

<p><a id="Server_Configuration" name="Server_Configuration"></a></p>

<h2>Server Configuration</h2>

<p><a id="Web_Servers" name="Web_Servers"></a></p>

<h3>Web Servers</h3>

<p>This is going to be the easiest part of the whole configurations. Since the webheads are really just drones, they're only going to be doing grunt work, so you need no special configurations. Thats right, don't even open the httpd.conf file, just put a file called index.html in /var/www/html/index.html. In this file you can put any distinguishing characteristics you want. I put "It works you looking at WebHead #" where # is the numerical identifier of that particular webhead.</p>

<p><a id="Load_Balancer" name="Load_Balancer"></a></p>

<h3>Load Balancer</h3>

<p>This is the tricky part of the operation, I'll walk through each step and then bring it together at the end for you, so you know what the end product should be. All of the configurations that we are going to go through should be placed at the bottom of /etc/httpd/conf/httpd.conf in a standard Virtual Host to work.</p>

<p><a id="Unwanted_Requests" name="Unwanted_Requests"></a></p>

<h4>Unwanted Requests</h4>

<p>We are not working as a Forwarding Proxy (better known as an Open Proxy, and this is bad news as it lets people mask their identity by using your server to view web pages for them, it has its uses but not in this scenario), turning off ProxyRequests will help avoid any unwanted traffic.</p>

<pre>
ProxyRequests off
</pre>

<p><a id="The_Balance" name="The_Balance"></a></p>

<h4>The Balance</h4>

<p>In this part of the Virtual Host we will be naming our web heads and declaring how we will be balancing. The BalanceMember directive is how you declare the webheads, of course you can add as many as you would like, using these as templates. The ProxySet directive declares how you would like to balance, we're going to use a "byrequest" balancing algorithm which is the same as a Round Robin, so for each new request you will get a new webhead. The order is sequential, there are better and smarter algorithms out there, but this is the easiest to configure and you need no knowledge of networking theory. All of this will be wrapped in &lt;Proxy&gt; tags which is how apache knows to send it to mod_proxy, the "balancer://mycluster" identifier is only an identifier, you could technically call it what you want as long as you put the "balancer://" prefix.</p>

<p><strong>Keep in mind you will want to contact your webheads from the load balancer with their private IPs, this will keep your bandwidth charges down to a minimum by keeping all communication between servers on the Service Net, where bandwidth is free. </strong></p>

<pre>
&lt;Proxy balancer://mycluster&gt;
    # WebHead1
    BalancerMember http://10.x.x.x:80
    
    # WebHead2
    BalancerMember http://10.x.x.x:80
    
    ProxySet lbmethod=byrequests

&lt;/Proxy&gt;

</pre>

<p><a id="Balance_Manager" name="Balance_Manager"></a></p>

<h4>Balance Manager</h4>

<p><strong>Optional Step </strong></p>

<p>This is a tool packaged with the mod_proxy_balancer tool, and allows you to make configurations from a gui tool through the web browser. Viewable at "<a class="external free" href="http://domain.com/balancer-manager" rel="nofollow" title="http://domain.com/balancer-manager">http://domain.com/balancer-manager</a>", keep in mind that these changes die after you restart apache. I won't go over how to use this tool, but it is available to you.</p>

<pre>
&lt;Location /balancer-manager&gt;

   SetHandler balancer-manager
&lt;/Location&gt;
</pre>

<p>&nbsp;</p>

<p><a id="ProxyPass" name="ProxyPass"></a></p>

<h4>ProxyPass</h4>

<p>This is the last part of the configuration, and just adds the situations that will need to be proxied. We don't want to proxy the balancer-manager, but we do want to proxy everything else.</p>

<pre>
   ProxyPass /balancer-manager&nbsp;!
   ProxyPass / balancer://mycluster/

</pre>

<p><a id="Summary" name="Summary"></a></p>

<h2>Summary</h2>

<p>Ok, so now if you've got all this in your httpd.conf on your load balancer CloudServer, and start up apache you should be able to view your domain name that is properly pointed to your load balancer. When you hit refresh it should hop between your two webheads, saying "It works you looking at WebHead 1" or "It works you looking at WebHead 2". Congratulations you are now balancing.</p>

<p>So what I've done for you is combine all the things that we've learned into a helpful packaged VirtualHost, just trade out all the necesary values that are specific to your configuration like the domain name and the IP addresses to your webheads. Also, there are some security additions that are explained in the comments, everything is commented so you don't have to refer back to this article to make changes later.</p>

<pre>
&lt;VirtualHost *:80&gt;
        ProxyRequests off
        
        ServerName domain.com

        &lt;Proxy balancer://mycluster&gt;
                # WebHead1
                BalancerMember http://10.176.42.144:80
                # WebHead2
                BalancerMember http://10.176.42.148:80

                # Security "technically we aren't blocking
                # anyone but this is the place to make 
                # those changes. 
                Require all granted
                # In this example all requests are allowed.

                # Load Balancer Settings
                # We will be configuring a simple Round
                # Robin style load balancer.  This means
                # that all webheads take an equal share of
                # of the load.
                ProxySet lbmethod=byrequests

        &lt;/Proxy&gt;

        # balancer-manager
        # This tool is built into the mod_proxy_balancer
        # module and will allow you to do some simple
        # modifications to the balanced group via a gui
        # web interface.
        &lt;Location /balancer-manager&gt;
                SetHandler balancer-manager

                # I recommend locking this one down to your
                # your office
                Require host example.org

        &lt;/Location&gt;

        # Point of Balance
        # This setting will allow to explicitly name the
        # the location in the site that we want to be
        # balanced, in this example we will balance "/"
        # or everything in the site.
        ProxyPass /balancer-manager&nbsp;!
        ProxyPass / balancer://mycluster/

&lt;/VirtualHost&gt;

</pre>

<p><strong>Note</strong>: The preceding example is formatted for Apache 2.4. If using 2.2, replace <strong>Require all granted </strong> with<strong> Order Deny,Allow | Deny from none | Allow from all</strong> and then replace <strong>Require host example.org</strong> with <strong>Order deny,allow | Deny from all | Allow from example.org</strong>.</p>

<hr />
<p>Stay tuned for the next article which will be <a href="/knowledge_center/index.php/Load_Balancing_an_SSL_site" title="Load Balancing an SSL site">Load Balancing an SSL site</a>.</p>

<hr />
<p>&nbsp;</p>

<div class="printfooter">&nbsp;</div>
