---
node_id: 1501
title: Configuring basic security
permalink: article/configuring-basic-security-0
type: article
created_date: '2012-07-24 00:23:38'
created_by: RackKCAdmin
last_modified_date: '2015-09-03 20:1215'
last_modified_by: constanze.kratel
products: Cloud Hosting
categories: Uncategorized
body_format: full_html
---

<p>Some people think that this is not dangerous if there are no services running on the server, and it doesn't matter that all ports are open. We disagree. If connections to unused (and popular) ports are blocked or dropped, then the vast majority of malicious intruders will move on to another machine where ports are accepting connections. It only takes a few minutes to set up a firewall - so we highly recommend that you do so to protect your server.</p>

<p>After you create a new cloud server, we recommend that you perform the following tasks to enhance security of the server:</p>

<ol>
	<li><a href="#LogIntoYourServer">Log in to the server</a></li>
	<li><a href="#ChangeTheRootPassword">Change the root password</a></li>
	<li><a href="#AddAnAdminUser">Add an Admin User</a></li>
	<li><a href="#SetUpPublicAndPrivateKeys">Set up public and private keys</a></li>
	<li><a href="#ModifyTheSSHConfiguration">Modify the SSH configuration</a></li>
	<li><span class="mw-headline"><a href="#SetUpAPrivateFirewall">Set up a private firewall by using iptables in Ubuntu</a>&nbsp;or&nbsp;</span><a href="#SetUpAPrivateFirewallUsingIPtables">Set up a private firewall using iptables in RedHat</a></li>
	<li><a href="#restartSSH" target="_self">Restart SSH</a></li>
</ol>

<p><strong>Note:</strong>&nbsp;Small modifications to the following commands might be necesssary if you're using a different distribution. If necessary, refer to your operating system documentation.</p>

<h2 id="LogIntoYourServer"><span class="mw-headline">Log in to the server</span></h2>

<p><span class="mw-headline">As soon as you have your server's IP address and password, log in using the following SSH command:</span></p>

<pre>
ssh root@123.45.67.890
</pre>

<p><strong>Note</strong>: If you're logging in to a rebuilt server, you might see a message stating that the remote host identification has changed.&nbsp;When you rebuild a cloud server, the remote host key changes, which indicates unusual or suspicious activity on your computer. To avoid this issue, remove the older entry for the server IP address. On your&nbsp;<em>local</em>&nbsp;computer, edit the SSH <code>known_hosts</code> file by using the following command and remove any entries that point to your cloud server IP address:</p>

<pre>
nano ~/.ssh/known_hosts</pre>

<p>If your local computer is running an operating system other than Linux or Mac OS X, the location of the <code>known_hosts</code> file will differ. Refer to your OS documention to learn the location of this file.</p>

<h2 id="ChangeTheRootPassword"><span class="mw-headline">Change the root password</span></h2>

<p>After logging in to your server, change the root password by issuing the following command:</p>

<pre>
passwd
</pre>

<h2 id="AddAnAdminUser">Add an Admin User</h2>

<p><strong>Note</strong>: If you are setting up additional SSH users for an OnMetal server, see&nbsp;<a href="http://www.rackspace.com/knowledge_center/article/using-onmetal-cloud-servers#uploadKey" target="_self">Uploading an SSH key</a> in the <a href="http://www.rackspace.com/knowledge_center/article/using-onmetal-cloud-servers" target="_blank">Using OnMetal Cloud Servers</a> article for applicable OnMetal steps.</p>

<ol>
	<li>To add an admin user, issue the following command and replace <strong>demo</strong> with the user name of your choice:

	<pre>
adduser demo</pre>

	<p><strong>Note</strong>: After this initial step, you should not log in as the root user to perform daily operations on your server. However, you'll need Super User (sudo) privileges to complete these administrative tasks.</p>
	</li>
	<li>To assign the sudo privileges to the admin user, issue the following command,&nbsp;which invokes the nano editor by default on Ubuntu:
	<pre>
visudo</pre>
	</li>
	<li>At the end of the file, add your admin user name (in place of demo in the following example) and the following text string:
	<pre>
demo   ALL=(ALL) ALL
</pre>
	</li>
	<li>When you are finished adding this line, exit, confirm, and save the file as follows:
	<ol start="1" type="a">
		<li>Press <strong>Ctrl-X</strong> to exit.</li>
		<li>Press&nbsp;<strong>y</strong> to confirm the changes.</li>
		<li>Press <strong>Enter</strong> to save the file as&nbsp;<code>/etc/sudoers.tmp</code>.
		<p><strong>Note</strong>: While working in the nano editor, the backspace/delete key works unexpectedly, deleting characters in front of the cursor rather than behind it. You can resolve this issue by editing the <code>/etc/nanorc</code> file (with nano, for example) and either uncommenting the following line or adding it:</p>

		<pre>
set rebinddelete
</pre>
		</li>
	</ol>
	</li>
</ol>

<p>The new behavior takes effect after you save the file and open nano again.</p>

<h2 id="SetUpPublicAndPrivateKeys"><span class="mw-headline">Set up public and private keys (SSH keygen)</span></h2>

<p>One effective way of securing SSH access to your cloud server is to use a&nbsp;<strong>public/private</strong>&nbsp;key, which means that a public key is placed on the server and the private key is on your local computer. This makes it impossible for someone to log in using just a password; they must have the private key. This setup consists of the following basic steps:&nbsp;create the key on your local computer, copy the public key to the server, and set the correct permissions for the key.</p>

<p>The following instructions assume that you use Linux or Mac OS X. For Windows instructions, see <a href="http://www.rackspace.com/knowledge_center/index.php/SSH_-_PuTTYgen">Key generation using Putty for Windows</a>.</p>

<h3>Step 1. Create the public and private keys</h3>

<ol>
	<li>On your local computer, create a folder to hold your keys:
	<pre>
mkdir ~/.ssh </pre>
	</li>
	<li>To create the SSH keys, on your&nbsp;<em>local</em> computer,&nbsp; enter the following command:
	<pre>
ssh-keygen -t rsa 
</pre>

	<ul>
		<li>The id_rsa and id_rsa.pub are created in the .ssh directory. The rsa.pub file holds the public key. You'll place this file on you server.</li>
	</ul>

	<ul>
		<li>The id_rsa file is your private key. Never show, give away, or keep this file on a public computer.</li>
	</ul>
	</li>
</ol>

<h3><span class="mw-headline">Step 2. Copy the public key</span></h3>

<p>You can use the&nbsp;<code>scp</code>&nbsp;command to place the public key on your server.&nbsp;</p>

<ol>
	<li>While still on your&nbsp;<em>local</em>&nbsp;computer, enter the following command, substituting your admin user for demo, IP address and admin user's home directory:

	<pre>
scp ~/.ssh/id_rsa.pub demo@123.45.67.890:/home/demo/
</pre>
	</li>
	<li>When prompted, enter the admin user password.</li>
	<li>Create a directory on the admin user's home folder&nbsp;on your server called .ssh and move the pub key into it, as shown in the following examples:
	<pre>
mkdir /home/demo/.ssh</pre>

	<pre>
mv /home/demo/id_rsa.pub /home/demo/.ssh/authorized_keys</pre>
	</li>
</ol>

<h3>Step 3. Modify SSH permissions</h3>

<p>Set the correct permissions on the key using the following commands, changing the "demo" user and group to your admin user and group:</p>

<pre>
chown -R demo:demo /home/demo/.ssh
chmod 700 /home/demo/.ssh
chmod 600 /home/demo/.ssh/authorized_keys 
</pre>

<p>You have now successfully created the key on your local computer, copied the public key to your server, and set the correct permissions for the key.&nbsp;</p>

<h2 id="ModifyTheSSHConfiguration"><span class="mw-headline">Modify the SSH configuration</span></h2>

<p>Keeping the SSH service on the default port of 22 makes it an easy target. We recommend changing the default SSH configuration to make it more secure.&nbsp;</p>

<ol>
	<li>Issue the following command:
	<pre>
nano /etc/ssh/sshd_config 
</pre>
	</li>
	<li>Change the default port of 22 to one of your choosing, turn off root logins, and define which users can log in:
	<pre>
Port 22                           &lt;--- <strong>change to a port of your choosing</strong>
Protocol 2
PermitRootLogin no
PasswordAuthentication no
UseDNS no
AllowUsers demo
</pre>

	<p><strong>Note</strong>: The port number can be any integer from 1025 through 65536. Be sure to note the new port number and remember to avoid port conflicts if you later configure additional listening processes.</p>
	</li>
</ol>

<p>Because you have set up a public/private key, you can set the PasswordAuthentication parameter to no. However, if you intend to access your server from different computers, you may want to leave PasswordAuthentication set to yes. Only use the private key if the local computer is secure (i.e. don't put the private key on a work computer).</p>

<p>Note that these settings are not enabled yet. Before restarting SSH by using the new port, you need to create a simple firewall by using iptables.</p>

<p><strong>NOTE: Do not restart SSH yet.</strong></p>

<h2 id="SetUpAPrivateFirewall"><span class="mw-headline">Set up a private firewall by using iptables</span></h2>

<p>The utility called iptables is the default firewall for Linux systems. It works by refusing connections to ports or services that you specify.</p>

<p><strong>Note:</strong> The procedure in this section does not apply to servers that use <code>systemd</code>. Servers that use <code>systemd</code> now use another firewall front end to iptables called FirewallD. The syntax and implementation for FirewallD vary greatly. For proper firewall configuration on FirewallD and <code>systemd</code> servers, see <a href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Security_Guide/sec-Using_Firewalls.html">Introduction to firewalld" at the Red Hat customer portal.</p>

<p>As part of this procedure, you'll open three ports:&nbsp;<strong>ssh</strong>,&nbsp;<strong>http</strong>, and&nbsp;<strong>https.</strong></p>

<p>You'll then create two files:</p>

<ul>
	<li>
	<p>/<code>etc/iptables.test.rules</code></p>
	</li>
	<li>
	<p><code>/etc/iptables.up.rules</code></p>
	</li>
</ul>

<p>The first is a set of temporary test rules and the second is the permanent set of rules iptables will use.</p>

<p>Note that you need to root user permissions to complete procedure. If you're not currently logged in as root, use the sudo command in front of the following commands.</p>

<ol>
	<li>Issue the following command to see what processes are currently running:
	<pre>
iptables -L
</pre>

	<p>You'll see something similar to this:</p>

	<pre>
Chain INPUT (policy ACCEPT)
target     prot opt source               destination

Chain FORWARD (policy ACCEPT)
target     prot opt source               destination

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination
</pre>

	<p>This means the server is are accepting anything from anyone on any port.</p>
	</li>
	<li>To build the firewall, create the file&nbsp;<code>/etc/iptables.test.rules</code>&nbsp;and add some rules. If you have worked through these steps previously, this file may not be empty:
	<pre>
nano /etc/iptables.test.rules 
</pre>
	</li>
	<li>Change and add ports as necessary.</li>
	<li>Issue the following command to apply the rules to your server:
	<pre>
iptables-restore &lt; /etc/iptables.test.rules
</pre>
	</li>
	<li>Issue the following command to note any differences:
	<pre>
iptables -L
</pre>
	</li>
	<li>If there is no change in the output, repeat the preceding steps and try again.</li>
	<li>Check the rules and see exactly what is being accepted, rejected and dropped. When you're satisfied with the rules, save them permanently by issuing the following command:
	<pre>
iptables-save &gt; /etc/iptables.up.rules
</pre>

	<p><strong>Note</strong>: If the server is rebooted before you save the rules permanently, the changes are lost and the server reverts to the previous settings.</p>
	</li>
	<li>Add a script that the system runs when your network interfaces are started. Create the file by running:
	<pre>
nano /etc/network/if-pre-up.d/iptables</pre>
	</li>
	<li>Add the following lines to the new file:
	<pre>
#!/bin/sh
/sbin/iptables-restore &lt; /etc/iptables.up.rules</pre>
	</li>
	<li>Save your changes, and then make the new script executable:
	<pre>
chmod +x /etc/network/if-pre-up.d/iptables</pre>
	</li>
</ol>

<h3 id="SetUpAPrivateFirewallUsingIPtables">Set up iptables in Red Hat</h3>

<p>If you are using a Red Hat distribution, iptables works a little differently than it does in an Ubuntu distribution. Using the following commands, you can change your iptables ruleset directly from the command line.</p>

<h4>HTTP - port 80</h4>

<p>For RHEL 7 and CentOS 7, use the following command to open port 80 for HTTP (web) traffic in your iptables firewall:</p>

<pre>
sudo firewall-cmd --add-service=http --permanent
</pre>

<p>For older OS versions, use the following command:</p>

<pre>
sudo /sbin/iptables -I RH-Firewall-1-INPUT 1 -p tcp --dport http -j ACCEPT
</pre>

<h4>HTTPS/SSL - port 443</h4>

<p>For RHEL 7 and CentOS 7, use the following command to open port 443 for secure HTTP traffic:</p>

<pre>
sudo firewall-cmd --add-service=https --permanent
</pre>

<p>For older OS versions, use the following command:</p>

<pre>
sudo /sbin/iptables -I RH-Firewall-1-INPUT 1 -p tcp --dport https -j ACCEPT
</pre>

<h4>SSH - port 22</h4>

<p>Although port 22 is open by default to allow you to SSH to your server after it is built, the following command shows you how you would open port 22 in RHEL 7 and CentOS 7:</p>

<pre>
sudo firewall-cmd --add-service=ssh -permanent
</pre>

<p>If you set up a custom port for SSH, use the following command for RHEL 7 and CentOS 7:</p>

<pre>
sudo firewall-cmd --add-port=&lt;customport&gt;/tcp --permanent
</pre>

<p>For older OS versions, use the following command to open port 22:</p>

<pre>
sudo /sbin/iptables -I RH-Firewall-1-INPUT 1 -p tcp --dport ssh -j ACCEPT
</pre>

<h4>FTP - port 21</h4>

<p>FTP is a common service for file transfer, but it is largely obsolete because it is not a secure protocol. We strongly recommend using a secure file transfer protocol like SFTP instead. &nbsp;If you absolutely have to use FTP, use the following command to open the default port of 21 in RHEL 7 and CentOS 7:</p>

<pre>
sudo firewall-cmd --add-service=ftp --permanent
</pre>

<p>For older OS versions, use the following commands:</p>

<pre>
sudo /sbin/iptables -I RH-Firewall-1-INPUT 1 -p tcp --dport ftp -j ACCEPT
sudo /sbin/iptables -I RH-Firewall-1-INPUT 1 -p tcp --dport ftp-data -j ACCEPT
</pre>

<h4>MySQL - port 3306</h4>

<p>If you need to make a remote connection to your MySQL database from another server, you must open port 3306 in iptables. For RHEL 7 and CentOS 7, use the following command:</p>

<pre>
sudo firewall-cmd --add-service=mysql --permanent
</pre>

<p>For older OS versions, use the following command:</p>

<pre>
sudo /sbin/iptables -I RH-Firewall-1-INPUT 1 -p tcp --dport mysql -j ACCEPT
</pre>

<h4>Save your rules</h4>

<p>Use the following command to save all the rules that you’ve created. &nbsp;If not saved before your server is rebooted, the iptables ruleset will revert to the default ruleset, blocking all traffic except on port 22. If you are using RHEL 7 or CentOS 7, this step is not necessary.</p>

<pre>
sudo /sbin/service iptables save
</pre>

<h4>Restart iptables</h4>

<p>Your changes to iptables take effect only after you have saved the rules and restarted the iptables service. &nbsp;Remember, if you restart iptables before saving your rules, iptables reverts to the default ruleset.</p>

<p>For RHEL 7 and CentOS 7, use the following command:</p>

<pre>
firewall-cmd --reload
</pre>

<p>For older OS versions, use the following command:</p>

<pre>
sudo /sbin/service iptables restart
</pre>

<h4>Check rules</h4>

<p>To check rules after reloading the firewall in RHEL 7 and CentOS 7, use the following commands:</p>

<pre>
firewall-cmd --get-active-zones
</pre>

<p>This returns which zone is active (the one you just saved all of your rules to).</p>

<pre>
firewall-cmd --zone=&lt;zone&gt; --list-all
</pre>

<p>This lists the enabled services in a specified zone.</p>

<h2><a name="restartSSH"></a>Restart ssh</h2>

<p>Now you can restart the SSH service. &nbsp;<strong>Stay logged in while you restart ssh and test it with a new connection.</strong>&nbsp;&nbsp;That way if an error occurs, you can troubleshoot it more easily.</p>

<p>On most distributions, the service is sshd, and you restart it with the command:</p>

<pre>
sudo service sshd restart
</pre>

<p>On Ubuntu and some other distributions, the service is called ssh and you restart it with a similar command:</p>

<pre>
sudo service ssh restart
</pre>

<p>If you have trouble making a new connection after restarting SSH, check the symptoms to determine what might be wrong.</p>

<ul>
	<li>If the connection times out, there might be a problem with the iptables configuration.</li>
	<li>If you get a warning about a private key, your key might not be installed on the server properly (check for extra line breaks or characters that were missed in a copy-and-paste operation).</li>
	<li>If you've been rebuilding the server, you might need to&nbsp;<a href="http://www.rackspace.com/knowledge_center/checking-ssh-host-fingerprint-with-the-web-console">remove the host key from your known_hosts file</a>&nbsp;before you can make a connection.</li>
</ul>

<h2>If you're locked out</h2>

<p>The incorrect configuration of SSH, sudo, or iptables could cause you to be locked out of your system. &nbsp;If this occurs, log in to the The Rackspace Cloud Control Panel and use the Web Console or Rescue Mode to repair the configurations.</p>

<p>These are the basics of connecting to a Linux Cloud Server and setting up security. &nbsp;See&nbsp;<a href="http://www.rackspace.com/knowledge_center/index.php/Logging_into_your_Server_via_RDP">Windows Cloud Server</a>&nbsp;to be perform these steps on a Windows server.</p>
