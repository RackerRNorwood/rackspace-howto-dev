---
node_id: 1119
title: MySQL Master-Master Replication
permalink: article/mysql-master-master-replication
type: article
created_date: '2011-06-07 19:06:14'
created_by: RackKCAdmin
last_modified_date: '2015-01-14 21:4140'
last_modified_by: rose.contreras
products: Cloud Servers
categories: 'High Availability - HA,MySQL'
body_format: tinymce
---

<p><strong>Note: Rackspace Support cannot assist with master-master replication setups due to the complexity of configuration and likelihood of error.</strong> &nbsp;As an alternative to direct MySQL master-master replication, consider either our <a href="http://www.rackspace.com/cloud/databases/">Cloud Databases</a> service or a replication engine like <a href="https://code.google.com/p/tungsten-replicator/">Tungsten</a>&nbsp;for more reliable data replication between database instances.</p>

<hr />
<table class="toc" id="toc" summary="Contents">
	<tbody>
		<tr>
			<td>
			<div id="toctitle">
			<h2>Contents</h2>
			</div>

			<ul>
				<li class="toclevel-1"><a href="#MySQL_Master-Master_Replication"><span class="tocnumber">1</span> <span class="toctext">MySQL Master-Master Replication</span></a>

				<ul>
					<li class="toclevel-2"><a href="#Setup_Outline"><span class="tocnumber">1.1</span> <span class="toctext">Setup Outline</span></a></li>
					<li class="toclevel-2"><a href="#Creating_the_Cloud_Servers"><span class="tocnumber">1.2</span> <span class="toctext">Creating the Cloud Servers</span></a></li>
					<li class="toclevel-2"><a href="#Installing_MySQL"><span class="tocnumber">1.3</span> <span class="toctext">Installing MySQL</span></a></li>
					<li class="toclevel-2"><a href="#Configuring_Replication"><span class="tocnumber">1.4</span> <span class="toctext">Configuring Replication</span></a></li>
					<li class="toclevel-2"><a href="#Testing_the_scenarios"><span class="tocnumber">1.5</span> <span class="toctext">Testing the scenarios</span></a></li>
				</ul>
				</li>
			</ul>
			</td>
		</tr>
	</tbody>
</table>

<p>&nbsp;</p>

<h2><span class="mw-headline">MySQL Master-Master Replication</span></h2>

<p>This article is about setting up <a href="http://dev.mysql.com/doc/refman/5.6/en/mysql-cluster-replication-multi-master.html" target="_blank">MySQL Master-Master database replication</a> between two Cloud Servers. Master-Master data replication allows for replicated data, stored on multiple computers, to be updated by any authorized contributing member of the group. This allows for more open collaboration than <a href="http://www.rackspace.com/knowledge_center/article/mysql-master-slave-replication">Master-Slave replication</a> where any needed changes identified by a group member must to be submitted to the designated "master" of the node.</p>

<p>The operating system we will use is Debian 5 (Lenny), built from the Rackspace Cloud base image.</p>

<p>&nbsp;</p>

<h2><span class="mw-headline">Setup Outline</span></h2>

<p>We will have two Cloud Servers, named <strong>debian501</strong> and <strong>debian502</strong> for the purpose of this exercise. Both servers have two IP addresses (one public, one private). We will configure the replication to be done over the private IP interface so that we don't incur any bandwidth charges.</p>

<p>&nbsp;</p>

<h2><span class="mw-headline">Creating the Cloud Servers</span></h2>

<p>You will need to create two Linux Cloud Servers, using the Debian 5 base image. Use the following steps to create each server separately.</p>

<ol>
	<li>Log&nbsp;in to the Cloud Control Panel.</li>
	<li>On the Cloud Servers page, click <strong>Create Server</strong>.</li>
	<li>Name the servers so that you can easily identify them during setup. In this exercise they are named <strong>debian501</strong>&nbsp;and <strong>debian502</strong>.</li>
	<li>Select the Debian image.</li>
	<li>Select the RAM configuration (flavor) meets your database requirements.</li>
	<li>Click <strong>Create Server</strong>.</li>
</ol>

<p>Note&nbsp;that the commands listed below are to be run as a privileged (root, sudo group) user.</p>

<p>&nbsp;</p>

<h2><span class="mw-headline">Installing MySQL</span></h2>

<p>First we need to install MySQL on both the Debian Cloud Servers. As always, prior to installing any packages, we need to make sure that our package list is up to date and our locale/language settings are configured properly.</p>

<ul>
	<li>Update the package database:</li>
</ul>

<pre>
 
#aptitude update
</pre>

<ul>
	<li>Install locales:</li>
</ul>

<pre>
 
#aptitude install locales
#dpkg-reconfigure locales
</pre>

<ul>
	<li>The <em>dpkg-reconfigure locales</em> command will bring up a locales setting window where you can choose the locales for your system depending on your country and region. In this case we have chosen <em>en_GB.UTF-8</em>.</li>
</ul>

<ul>
	<li>Now, you can run the following commands to install MySQL:</li>
</ul>

<pre>
 
#aptitude install mysql-server mysql-client libmysqlclient15-dev
</pre>

<p>&nbsp;</p>

<h2><span class="mw-headline">Configuring Replication</span></h2>

<p>Once the <em>mysql-server</em> package has been installed successfully, we can start configuring each of the MySQL nodes in order to enable replication between them.</p>

<p>We need to create the database that will be replicated as well as the replication username and password to be used with it. You can use the commands outlined below to set them up, remembering to change all the strings/values in brackets to apply to your specific configuration.</p>

<ul>
	<li>First on debian501, login to the <em>mysql console</em> (using mysql root password setup during MySQL installation).</li>
</ul>

<pre>
 
#mysql -u root –p
mysql&gt;
</pre>

<ul>
	<li>Now let’s create the replication user, which will be used to synchronize the changes.</li>
</ul>

<pre>
 
mysql&gt; grant replication slave on *.* to slaveuser@'[private IP of debian502]' identified by '[some password]';
mysql&gt; flush privileges;
mysql&gt; exit
</pre>

<ul>
	<li>Do the same for debian502</li>
</ul>

<pre>
 
mysql&gt; grant replication slave on *.* to slaveuser@'[private IP of debian501]' identified by '[some password]';
mysql&gt; flush privileges;
mysql&gt; exit
</pre>

<ul>
	<li>Back on debian501, edit <em>/etc/mysql/my.cnf</em> and insert/update or uncomment following entries:</li>
</ul>

<pre>
 
bind-address = 0.0.0.0
server-id = 1
log-bin = /var/log/mysql/var/bin.log
log-slave-updates
log-bin-index = /var/log/mysql/log-bin.index
log-error = /var/log/mysql/error.log
 
relay-log = /var/log/mysql/relay.log
relay-log-info-file = /var/log/mysql/relay-log.info
relay-log-index = /var/log/mysql/relay-log.index
 
auto_increment_increment = 10
auto_increment_offset = 1
master-host = [private IP address of debian502]
master-user = [replication username]
master-password = [replication password]
 
replicate-do-db = &lt;database name to be replicated&gt;
</pre>

<ul>
	<li>Repeat the steps on the debian502 server</li>
</ul>

<pre>
 
bind-address = 0.0.0.0
server-id = 2
log-bin = /var/log/mysql/bin.log
log-slave-updates
log-bin-index = /var/log/mysql/log-bin.index
log-error = /var/log/mysql/error.log
 
relay-log = /var/log/mysql/relay.log
relay-log-info-file = /var/log/mysql/relay-log.info
relay-log-index = /var/log/mysql/relay-log.index
 
auto_increment_increment = 10
auto_increment_offset = 2
master-host =  [private IP address of debian501]
master-user = [replication username]
master-password = [replication user password]
 
replicate-do-db = [database name to be replicated]
</pre>

<ul>
	<li>Now, restart both databases. If the service restart on either server fails, then please check the <em>/var/log/mysql/error.log</em> file for any errors. Update the configuration and check for any typos, etc.,</li>
</ul>

<p>&nbsp;</p>

<h2><span class="mw-headline">Testing the scenarios</span></h2>

<p>For the purpose of testing our replication setup, we can create the database specified in the configuration section above (replicate-do-db), as well as a test table on one of the nodes and watch the log files in /var/log/mysql directory. Note that all database changes should be replicated to our other server immediately.</p>

<pre>
 
mysql&gt; create database [your-db-name];
mysql&gt; use [your-db-name]
mysql&gt; create table foo (id int not null, username varchar(30) not null);
mysql&gt; insert into foo values (1, 'bar');
</pre>

<ul>
	<li>An additional test is to stop the MySQL service on debian502, making database changes on the debian501 server and then restarting the MySQL service on debian502. The debian502 MySQL service should sync up all the new changes automatically.</li>
</ul>

<ul>
	<li>You should also consider changing the default binary log rotation values (expire_logs_days and max_binlog_size) in the /etc/mysql/my.cnf file, as by default all the binary logs will be kept for 10 days. If you have high transaction count on your database application then it can cause significant hard disk space usage in logs. So, we recommend changing those values to match your server backup policies. For example, if you have daily backups setup of your MySQL node then it makes no sense to keep 10 days worth of binary logs.</li>
</ul>
