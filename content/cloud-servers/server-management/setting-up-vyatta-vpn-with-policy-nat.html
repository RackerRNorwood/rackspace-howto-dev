---
node_id: 3671
title: Setting Up Vyatta VPN with Policy NAT
permalink: article/setting-up-vyatta-vpn-with-policy-nat
type: article
created_date: '2013-09-03 17:12:36'
created_by: sameer.satyam
last_modified_date: '2013-09-17 17:3226'
last_modified_by: jered.heeschen
products: Cloud Servers
categories: Server Management
body_format: tinymce
---

<p>The following information will direct you in setting up your traffic sourced from 2 of your cloud servers to appear as the public IP of your cloud servers across the VPN tunnel only (Policy Nat).</p><ul type="disc"><li><strong>Cloud Server 1</strong> Cloud Networks IP: 172.26.26.2</li><li><strong>Cloud Server 2</strong> Cloud Networks IP: 172.26.26.3</li></ul><p>In this scenario, the 2 IP addresses appear to come from the 10.255.255.x. We will present two alternative solutions for this. One solution, we will map only the specific /32 addresses in our policy NAT. In the second solution, we will policy NAT the entire /24 subnet to the other /24 subnet.</p><h4>Scenario Notes</h4><p>Note: This assumes that the cloud servers have their default gateways pointed at the Vyatta (much in the same way a cloud server gets "rack connected" to an ASA or an F5). If you wish to continue to your cloud serversâ€™ public interface for Internet access and the cloud networks interface for VPN only traffic, your server admin will need to create a static route on the cloud server for the remote VPN encryption domain that points at the Vyatta's cloud network IP address.</p><p>Vyatta calls their static NAT a "bi-directional NAT". So when searching Vyatta's documentation, please keep this in mind.</p><h4>Topology</h4><h5>Local Vyatta Firewall</h5><table border="0" cellpadding="0"><tbody><tr><td><p align="center"><strong>Interface</strong></p></td><td><p align="center"><strong>IP Address</strong></p></td><td><p align="center"><strong>Description</strong></p></td></tr><tr><td><p>eth0</p></td><td><p>166.78.184.111/24</p></td><td><p>public</p></td></tr><tr><td><p>eth1</p></td><td><p>172.26.26.1/24</p></td><td><p>INSIDE-172.26.26.0/24</p></td></tr></tbody></table><h5>Remote Cisco ASA Firewall</h5><table border="0" cellpadding="0"><tbody><tr><td><p align="center"><strong>Interface</strong></p></td><td><p align="center"><strong>IP Address</strong></p></td><td><p align="center"><strong>Description</strong></p></td></tr><tr><td><p>eth 0/0</p></td><td><p><span style="line-height: 1.538em;">192.0.2.10</span>/28</p></td><td><p>outside</p></td></tr><tr><td><p>eth 0/1</p></td><td><p>192.168.10.1/24</p></td><td><p>INSIDE-192.168.10.0/24</p></td></tr><tr><td><p>eth 0/2</p></td><td><p>192.168.19.1/24</p></td><td><p>DMZ-192.168.19.0/24</p></td></tr></tbody></table><h4>VPN Details</h4><h5>Encryption Domains</h5><table border="0" cellpadding="0"><tbody><tr><td><p align="center"><strong>Local VPN Encryption Domains</strong></p></td><td><p align="center"><strong>Remote VPN Encryption Domains</strong></p></td></tr><tr><td><p>INSIDE-172.26.26.0/24</p></td><td><p>DMZ-192.168.19.0/24</p></td></tr></tbody></table><h5>ISAKMP and IPSEC Settings</h5><table border="0" cellpadding="0"><tbody><tr><td><p align="center"><strong>Phase 1 Settings</strong></p></td><td><p align="center"><strong>Phase 2 Settings</strong></p></td></tr><tr><td><p>AES-256</p></td><td><p>AES-256</p></td></tr><tr><td><p>SHA1</p></td><td><p>SHA1</p></td></tr><tr><td><p>Group 5</p></td><td><p>PFS Group 5</p></td></tr><tr><td><p>86400 Seconds</p></td><td><p>3600 Seconds</p></td></tr></tbody></table><h4>VPN Configuration</h4><h5>Enable the VPN daemon on the outside interface</h5><table border="0" cellpadding="0"><tbody><tr><td><p># Enable the VPN daemon on the eth0 Interface <br /> set vpn ipsec ipsec-interfaces interface eth0</p></td></tr></tbody></table><h5>Phase 1 Define the Policies</h5><table border="0" cellpadding="0"><tbody><tr><td><p># Phase 1 Settings: AES-256, SHA1, Group 5, Lifetime 86400 <br /> set vpn ipsec ike-group <strong>IKE-POLICY-10</strong> lifetime 86400 <br /> set vpn ipsec ike-group <strong>IKE-POLICY-10</strong> proposal 1 dh-group 5 <br /> set vpn ipsec ike-group <strong>IKE-POLICY-10</strong> proposal 1 encryption aes256 <br /> set vpn ipsec ike-group <strong>IKE-POLICY-10</strong> proposal 1 hash sha1</p></td></tr></tbody></table><h5>Phase 2 Define the ESP-GROUP (Like an ASA Transform Set)</h5><table border="0" cellpadding="0"><tbody><tr><td><p># Phase 2 Settings: AES-256, SHA1, PFS Group 5, Lifetime 3600 <br /> set vpn ipsec esp-group <strong>AES-256-SHA-PFS-GROUP-5-3600</strong> lifetime 3600 <br /> set vpn ipsec esp-group <strong>AES-256-SHA-PFS-GROUP-5-3600</strong> mode tunnel <br /> set vpn ipsec esp-group <strong>AES-256-SHA-PFS-GROUP-5-3600</strong> pfs enable <br /> set vpn ipsec esp-group <strong>AES-256-SHA-PFS-GROUP-5-3600</strong> proposal 1 encryption aes256 <br /> set vpn ipsec esp-group <strong>AES-256-SHA-PFS-GROUP-5-3600</strong> proposal 1 hash sha1</p></td></tr></tbody></table><h5>Phase 2 Define the Individual Peer Attributes</h5><table border="0" cellpadding="0"><tbody><tr><td><p>set vpn ipsec site-to-site peer 192.0.2.10 description "VPN TO TANGO LAB ASA-5510" <br /> set vpn ipsec site-to-site peer 192.0.2.10 authentication mode pre-shared-secret <br /> set vpn ipsec site-to-site peer 192.0.2.10 authentication pre-shared-secret netsecR@wks <br /> set vpn ipsec site-to-site peer 192.0.2.10 default-esp-group <strong>AES-256-SHA-PFS-GROUP-5-3600</strong> <br /> set vpn ipsec site-to-site peer 192.0.2.10 ike-group <strong>IKE-POLICY-10</strong> <br /> set vpn ipsec site-to-site peer 192.0.2.10 local-address 166.78.184.111</p></td></tr></tbody></table><h5>Phase 2 Define the Tunnel Attributes (Encryption Domains)</h5><table border="0" cellpadding="0"><tbody><tr><td><p># Tunnel 1 Local Cloud Networks (Inside) to remote DMZ <br /> set vpn ipsec site-to-site peer 192.0.2.10 tunnel 1 allow-nat-networks disable <br /> set vpn ipsec site-to-site peer 192.0.2.10 tunnel 1 allow-public-networks disable <br /> set vpn ipsec site-to-site peer 192.0.2.10 tunnel 1 esp-group AES-256-SHA-PFS-GROUP-5-3600 <br /> set vpn ipsec site-to-site peer 192.0.2.10 tunnel 1 local prefix 10.255.255.0/24 <br /> set vpn ipsec site-to-site peer 192.0.2.10 tunnel 1 remote prefix 192.168.19.0/24</p><p># Tunnel 2 Local Cloud Networks (Inside) to remote INSIDE <br /> set vpn ipsec site-to-site peer 192.0.2.10 tunnel 2 allow-nat-networks disable <br /> set vpn ipsec site-to-site peer 192.0.2.10 tunnel 2 allow-public-networks disable <br /> set vpn ipsec site-to-site peer 192.0.2.10 tunnel 2 esp-group AES-256-SHA-PFS-GROUP-5-3600 <br /> set vpn ipsec site-to-site peer 192.0.2.10 tunnel 2 local prefix 10.255.255.0/24 <br /> set vpn ipsec site-to-site peer 192.0.2.10 tunnel 2 remote prefix 192.168.10.0/24</p></td></tr></tbody></table><h4>Solution 1: Policy NAT Configuration With Individual Addresses</h4><h5>VPN NAT</h5><table border="0" cellpadding="0"><tbody><tr><td><p align="center"><strong>NAT traffic bidirectionally mapping 172.26.26.2 &lt;--&gt; 10.255.255.202 and 172.26.26.3 &lt;--&gt; 10.255.255.203</strong></p></td></tr><tr><td><p># Rule 10 - <strong>NAT 172.26.26.2 &lt;--&gt; 10.255.255.2 when traffic is destined for the remote VPN encryption domain</strong> <br /> set nat <strong>destination</strong> rule 10 description "172.26.26.2 - 10.255.255.202 Policy Nat" <br /> set nat <strong>destination</strong> rule 10 source address 192.168.19.0/24 <br /> set nat <strong>destination</strong> rule 10 destination address 10.255.255.202 <br /> set nat <strong>destination</strong> rule 10 inbound-interface eth0 <br /> set nat <strong>destination</strong> rule 10 translation address 172.26.26.2 <br /> set nat <strong>source</strong> rule 10 description "172.26.26.2 - 10.255.255.202 Policy Nat" <br /> set nat <strong>source</strong> rule 10 outbound-interface eth0 <br /> set nat <strong>source</strong> rule 10 source address 172.26.26.2 <br /> set nat <strong>source</strong> rule 10 destination address 192.168.19.0/24 <br /> set nat <strong>source</strong> rule 10 translation address 10.255.255.202</p><p># Rule 20 - <strong>NAT 172.26.26.3 &lt;--&gt; 10.255.255.3 when traffic is destined for the remote VPN encryption domain</strong> <br /> set nat <strong>destination</strong> rule 20 description "172.26.26.3 - 10.255.255.203 Policy Nat" <br /> set nat <strong>destination</strong> rule 20 source address 192.168.19.0/24 <br /> set nat <strong>destination</strong> rule 20 destination address 10.255.255.203 <br /> set nat <strong>destination</strong> rule 20 inbound-interface eth0 <br /> set nat <strong>destination</strong> rule 20 translation address 172.26.26.3 <br /> set nat <strong>source</strong> rule 20 description "172.26.26.3 - 10.255.255.203 Policy Nat" <br /> set nat <strong>source</strong> rule 20 outbound-interface eth0 <br /> set nat <strong>source</strong> rule 20 source address 172.26.26.3 <br /> set nat <strong>source</strong> rule 20 destination address 192.168.19.0/24 <br /> set nat <strong>source</strong> rule 20 translation address 10.255.255.203</p><p># Rule 50 - <strong>PAT all other traffic from 172.26.26.0/24 as the outside interface's IP Address</strong> (Outside PAT Overload) <br /> # Note that this traffic would not be destined for the VPN but for unencrypted Internet traffic <br /> set nat source rule 50 description "POLICY PAT INSIDE TO Internet" <br /> set nat source rule 50 outbound-interface eth0 <br /> set nat source rule 50 source address 172.26.26.0/24 <br /> set nat source rule 50 translation address masquerade</p></td></tr></tbody></table><h4>Solution 2: Policy NAT Subnet to Subnet</h4><h5>VPN NAT</h5><table border="0" cellpadding="0"><tbody><tr><td><p align="center"><strong> NAT traffic bidirectionally mapping the entire subnets 172.26.26.0/24 &lt;--&gt; 10.255.255.0/24 <br /> eg: 172.26.26.2 &lt;--&gt; 10.255.255.2 and 172.26.26.3 &lt;--&gt; 10.255.255.3 </strong></p></td></tr><tr><td><p># Rule 10 - <strong>NAT 172.26.26.0/24 &lt;--&gt; 10.255.255./24 when traffic is destined for the remote VPN encryption domain</strong> <br /> set nat <strong>destination</strong> rule 10 description "172.26.26.0/24 - 10.255.255.0/24 Policy Nat" <br /> set nat <strong>destination</strong> rule 10 source address 192.168.19.0/24 <br /> set nat <strong>destination</strong> rule 10 destination address 10.255.255.0/24 <br /> set nat <strong>destination</strong> rule 10 inbound-interface eth0 <br /> set nat <strong>destination</strong> rule 10 translation address 172.26.26.0/24 <br /> set nat <strong>source</strong> rule 10 description "172.26.26.0/24 - 10.255.255.0/24 Policy Nat" <br /> set nat <strong>source</strong> rule 10 outbound-interface eth0 <br /> set nat <strong>source</strong> rule 10 source address 172.26.26.0/24 <br /> set nat <strong>source</strong> rule 10 destination address 192.168.19.0/24 <br /> set nat <strong>source</strong> rule 10 translation address 10.255.255.0/24</p><p># Rule 50 - <strong>PAT all other traffic from 172.26.26.0/24 as the outside interface's IP Address</strong> (Outside PAT Overload) <br /> # Note that this traffic would not be destined for the VPN but for unencrypted Internet traffic <br /> set nat source rule 50 description "POLICY PAT INSIDE TO Internet" <br /> set nat source rule 50 outbound-interface eth0 <br /> set nat source rule 50 source address 172.26.26.0/24 <br /> set nat source rule 50 translation address masquerade</p></td></tr></tbody></table>
