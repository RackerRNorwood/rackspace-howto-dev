---
node_id: 667
title: How to use Cron to Backup CloudSites to CloudFiles
permalink: article/how-to-use-cron-to-backup-cloudsites-to-cloudfiles
type: article
created_date: '2011-03-16 21:57:40'
created_by: RackKCAdmin
last_modified_date: '2014-08-25 03:1944'
last_modified_by: rose.contreras
products: Cloud Sites
categories: Scheduled Cron Jobs
body_format: tinymce
---

<p><strong>NOTE:</strong> This article refers to the <a href="https://manage.rackspacecloud.com/" target="_blank">Cloud Sites Control Panel</a>. You can access this interface from the <a href="https://mycloud.rackspace.com/" target="_blank">Cloud Control Panel</a> by clicking your username in the upper-right corner of the control panel and selecting Cloud Sites Control Panel.<em><br /></em></p>
<p><strong>NOTE:</strong> The library used by this script is <strong>no longer supported</strong>. &nbsp;We suggest Cloud Sites customers <a href="/knowledge_center/article/scheduled-backup-cloud-sites-to-cloud-files">use the Zipit tool</a> to run scheduled backups through cron instead.</p>
<p>Before using the scripts in this article, consider <a href="/knowledge_center/article/scheduled-backup-cloud-sites-to-cloud-files">this more comprehensive script</a> that can be installed for your site. &nbsp;While the scripts in this article serve as a simple example, <a href="/knowledge_center/article/scheduled-backup-cloud-sites-to-cloud-files">the other script</a> offers more robust logging and error checking for long-term use.</p>
<p>In order to backup Cloud Sites to Cloud Files using this example, you will need to create two cron jobs. One cron job will backup the cloud site and database and the second cron job will upload the backup to Cloud Files. This is a very simple example and should not be used for extremely large sites and databases to backup to Cloud Files.</p>
<p><strong>Step 1</strong></p>
<p>For the first cron, create a file called backup.sh. This file should be placed in the root of your domain. You will want to place the following code inside of it&nbsp;::</p>
<pre>#!/bin/sh

#Set information specific to your site
webroot="YOUR WEBROOT"
db_host="YOUR DB HOST"
db_user="YOUR DB USERNAME"
db_password="YOUR DB PASSWORD"
db_name="YOUR DB NAME"

#Set the date and name for the backup files
date=`date '+%F-%H-%M'`
backupname="backup.$date.tar.gz"

#Dump the mysql database

mysqldump -h $db_host -u $db_user --password="$db_password" $db_name &gt; $webroot/db_backup.sql

#Backup Site
tar -czpvf $webroot/sitebackup.tar.gz $webroot/web/content/

#Compress DB and Site backup into one file
tar --exclude 'sitebackup' --remove-files -czpvf $webroot/$backupname $webroot/sitebackup.tar.gz $webroot/db_backup.sql

#Upload your files to cloud files.
#First argument is the location of the backup file, second argument is the name to be used when uploaded
php $webroot/cloudfiles_backup.php $webroot/$backupname $backupname

#After your backup has been uploaded, remove the tar ball from the filesystem.
rm $webroot/$backupname
</pre>
<p>In the above script, you will need to replace the portions in ALL CAPS with your actual information as follows&nbsp;::</p>
<p><strong>YOUR WEBROOT</strong>&nbsp;- This is the absolute path to your files. You can find this path by clicking on Hosting, Cloud Sites, Features, and scrolling down. This will be the "Linux Path" listed there. An example would be: /mnt/target02/123456/www.domain.com (Note, the /web/content is not included in that path)</p>
<p><strong>YOUR DB HOST</strong> - Database Host an example would be mysql5-9.wc1 or mysql50-78.wc1.dfw1.stabletransit.com</p>
<p><strong>YOUR DB PASSWORD</strong> - the password on this database (note the single quotes and that there is no space between the -p and the single quote)</p>
<p><strong>YOUR DB USER</strong> - the database username (e.g.: 12345_username)</p>
<p><strong>YOUR DB NAME</strong> - the name of the database you are backing up (e.g.: 12345_database_name). Note that there is no parameter for this option unlike the previous examples (-h -p and -u respectively).</p>
<p>Place this file in your web root.</p>
<p><strong>Step 2</strong></p>
<p>For this step, you will need to have access to Cloud Files. If you are not sure or have not set up Cloud Files on your account, please visit <a class="new" title="How do I access Cloud Files? (page does not exist)" href="/knowledge_center/index.php/How_do_I_access_Cloud_Files">How do I Access Cloud Files</a> for more information on setting up your Cloud Files account. Also, please note that you may incur any charges associated with using Cloud Files. For more information regarding Cloud Files costs please visit&nbsp;:: <a class="external free" title="http://www.rackspacecloud.com/cloud_hosting_products/files/pricing/" href="http://www.rackspacecloud.com/cloud_hosting_products/files/pricing/" rel="nofollow">http://www.rackspacecloud.com/cloud_hosting_products/files/pricing/</a></p>
<p>Now obtain and set up the PHP API. To download the PHP API documentation and files, click <a href="https://github.com/rackerlabs/php-cloudfiles" target="_blank">here</a>. If you click the "Downloads" button you can then download the files in a zip archive.</p>
<p>Once you download the archive, unpack it. &nbsp;Then go to your site root and create a directory named "cloudfiles". &nbsp;Upload the files that were in the PHP API archive into the new "cloudfiles" directory. Once it's uploaded the contents of the /YOUR_WEB_ROOT/cloudfiles/ directory should look similar to this picture:</p>
<p><img src="http://c0935082.cdn.cloudfiles.rackspacecloud.com/ftpstructure.png" alt="ftpstructure.png" /></p>
<p>Next you will need to create a simple PHP script to connect to Cloud Files and upload the backup you are creating. We'll call it "cloudfiles_backup.php" and put it in the same location as the shell script (your web root directory). &nbsp;This file will be called by the shell script we wrote earlier, so if you change that name make sure to find its reference in the shell script and change it there too.</p>
<p>Here are the contents of the script:</p>
<pre>&lt;?php

// include the API - note we must use the absolute server path because this script will be executed through php technology and not http
require("/YOUR WEBROOT/cloudfiles/cloudfiles.php");

// cloud info
$username = "YOUR USERNAME"; // username
$key = "YOUR API KEY"; // api key
$containername = "YOUR CONTAINER NAME";  // container name 

// backup file name from command-line argument
$backup = $argv[1];

// Name to use for file once uploaded
$uploadname = $argv[2];

// Connect to Rackspace
$auth = new CF_Authentication($username, $key);
$auth-&gt;authenticate();
$conn = new CF_Connection($auth);

// Get the container we want to use
$container = $conn-&gt;get_container($containername);

// upload file to Rackspace
$object = $container-&gt;create_object($uploadname);
$object-&gt;load_from_filename($backup);
?&gt;
</pre>
<p>Like the first script, in the above script you will need to replace the portions in ALL CAPS with your proper values. &nbsp;This includes:</p>
<p><strong>YOUR WEBROOT</strong> - As it was before, this is your Linux path, as specified under the "Features" tab for your site.</p>
<p><strong>YOUR USERNAME</strong> - Your Rackspace Cloud Files user name (the one you use to log into the control panel).</p>
<p><strong>YOUR API KEY</strong> - Your Cloud Files API key. &nbsp;You can get the API key in the control panel in the "Your Account" section in the sidebar, under "API Access".</p>
<p><strong>YOUR CONTAINER NAME</strong> - The name of the container you're using on Cloud Files to hold the backup file.</p>
<p><strong>Step 3</strong></p>
<p>The final step is to automate all of this by setting up the actual cron job within your control panel.</p>
<p>The task we create will execute the backup.sh script we created during step 1. The following screen shows a sample of the setup process in the Classic Cloud Control Panel for this task. Please note that the date, time and frequency can be modified to best suite your needs.</p>
<p>&nbsp;</p>
<p><img src="http://c0935082.cdn.cloudfiles.rackspacecloud.com/cronsetup.png" alt="cronsetup.png" /></p>
<p>In the above example we chose "Perl" as the scripting language (the "Perl" option is used to run shell scripts as well) and scheduled the task to run daily at 6:45 AM Central time.</p>
<p>Now you have created a method to backup your Cloud Site to your Cloud Files account. Using our cron system will allow you to regulate how often you would like to create and upload your backups.</p>
<p><strong>Resources and Disclaimer</strong></p>
<p><strong>Cron FAQ's:</strong> <strong>What is a cron job:</strong> <a class="external free" title="/knowledge_center/index.php/What_is_a_cron_job%3F" href="/knowledge_center/index.php/What_is_a_cron_job%3F" rel="nofollow">/knowledge_center/index.php/What_is_a_cron_job%3F</a></p>
<p><strong>How do I enable cron:</strong> <a class="external free" title="/knowledge_center/index.php/How_do_I_enable/disable_a_cron_job%3F" href="/knowledge_center/index.php/How_do_I_enable/disable_a_cron_job%3F" rel="nofollow">/knowledge_center/index.php/How_do_I_enable/disable_a_cron_job%3F</a></p>
<p><strong>How do I schedule a cron job:</strong> <a class="external free" title="/knowledge_center/index.php/How_do_I_schedule_a_cron_job%3F" href="/knowledge_center/index.php/How_do_I_schedule_a_cron_job%3F" rel="nofollow">/knowledge_center/index.php/How_do_I_schedule_a_cron_job%3F</a></p>
<p><strong>How do I import a large Mysql Database</strong></p>
<p><a class="external free" title="/knowledge_center/index.php/How_do_I_import_a_large_Mysql_Database" href="/knowledge_center/index.php/How_do_I_import_a_large_Mysql_Database" rel="nofollow">/knowledge_center/index.php/How_do_I_import_a_large_Mysql_Database</a></p>
<p><strong>Cloud Files Knowledge Base</strong></p>
<p><a class="external free" title="/knowledge_center/index.php/Main_Page" href="/knowledge_center/index.php/Main_Page" rel="nofollow">/knowledge_center/index.php/Main_Page</a></p>
<p><strong>The Rackspace Cloud is not able to provide code support for your Cloud Sites and web applications. This article is designed to offer a very simple script that will backup your Cloud Site to your Cloud Files account. You are welcome to modify any part of these scripts to meet your own needs.</strong></p>
