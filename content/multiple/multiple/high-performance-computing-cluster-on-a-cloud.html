---
node_id: 3352
title: High Performance Computing Cluster in a Cloud Environment
permalink: article/high-performance-computing-cluster-on-a-cloud
type: article
created_date: '2013-03-18 15:51:13'
created_by: alyssah
last_modified_date: '2014-01-26 05:0110'
last_modified_by: jered.heeschen
products: 'Cloud Servers,Rackspace Private Cloud - OpenStack'
categories: 'Performance,Programming'
body_format: tinymce
---

<h2>High Performance Computing</h2><p>High Performance Computing (HPC) enables scientists and researchers to solve complex problems that require many computing capabilities. HPC typically utilizes a message passing interface (MPI) to communicate between different nodes.&nbsp;</p><h3>HPC in Cloud</h3><p>Currently, most projects requiring HPC are still running on legacy Unix systems. Migrating these projects to a Cloud-based installation is very simple and does not require much additional setup. In this tutorial, we will build an HPC cluster with Open MPI on the Rackspace Cloud. Next, we will run an Open MPI application on top of our cluster. By the end of this tutorial, you will know how to leverage the Cloud to rapidly build and scale an HPC cluster for real-time data processing while removing the dependency on physical infrastructure.</p><h3>Open MPI</h3><p>To achieve high performance clustering in the Cloud, we will use Open MPI, which is a Message Passing Interface project. It provides parallel processing, thread safety and concurrency, dynamic process spawning, and network and fault tolerance. This library is used by the world’s fastest super computers and is instrumental in powering many petaflops. To find out more about Open MPI library, visit their site: <a href="http://www.open-mpi.org/">http://www.open-mpi.org/</a>.</p><h2>Objective</h2><p>In this tutorial, we will show you how to build an HPC cluster using the following:</p><ol type="1" start="1"><li>Four Rackspace Cloud Servers</li><li>Open MPI</li></ol><h2>Prerequisites</h2><p>The following prerequisites are expected for successful completion of this tutorial:</p><ul type="disc"><li>Rackspace Cloud account ( <a href="https://cart.rackspace.com/cloud/">https://cart.rackspace.com/cloud/</a> )</li><li>SSH client (Windows users download PuTTY from here: <a href="http://www.chiark.greenend.org.uk/~sgtatham/putty/download.html">http://www.chiark.greenend.org.uk/~sgtatham/putty/download.html</a> )</li><li>A basic knowledge of Linux and Open MPI</li></ul><h2>Installation Process</h2><p>In this tutorial, we will be setting up a four-node cluster, running applications on it, and gauging the performance.&nbsp;</p><p><img src="/knowledge_center/sites/default/files/field/image/HPC_Cluster.png" alt="" width="557" height="343" /></p><p><em>Figure 1 -&nbsp;HPC on the Cloud High Level Architecture</em></p><p>&nbsp;</p><h3>Overview</h3><p>In this tutorial, we will show you how to:</p><ol><li>Create a Cloud Server</li><li>Install Open MPI</li><li>Enable Clustering</li><li>Configure HPC</li><li>Create and deploy a Cloud Server image</li><li>Install and run a sample Open MPI enabled application</li></ol><h4>1. Create a cloud Server</h4><p>Login to <a href="https://mycloud.rackspace.com">https://mycloud.rackspace.com</a> and create a Cloud Server from the web interface with the following attributes.</p><ol type="0"><li>Server name: <strong>yourname-HPC-node-01</strong></li><li>Region: <strong>Dallas (DFW)</strong></li><li>Image (Rackspace): <strong>Ubuntu 12.04 LTS (Precise Pangolin)</strong></li><li>Size: <strong>2GB of RAM</strong> or higher</li><li>Click: <strong>Create Server</strong></li></ol><p>The Cloud Server will begin building. &nbsp;During this time, a popup will appear with the Cloud Server password. Record this information as you will need it later. Dismiss the popup window and wait for the server build to complete. Write down IP address for the server as it becomes available.</p><h4>2. Install Open MPI</h4><p>Once the server finishes building and is in Available status, SSH into it and log in using the IP address and password you recorded earlier.&nbsp;</p><pre><code>ssh root@&lt;Your Server IP&gt;</code></pre><p>After logging in, execute the following commands:</p><pre><code>apt-get update<br />apt-get install build-essential –y<br />apt-get install openmpi-bin openmpi-checkpoint openmpi-common openmpi-doc libopenmpi-dev -y</code></pre><h4>3. Enable Clustering</h4><p>As mentioned earlier, Open MPI facilitates communication between nodes via SSH, therefore, we will need to enable key-based logins for SSH.</p><p>To do this, run the following commands:</p><pre><code>chmod 700 ~/.ssh<br />echo "StrictHostKeyChecking no" &gt;&gt; /etc/ssh/ssh_config<br />ssh-keygen -t rsa -b 2048 -f ~/.ssh/id_rsa -C "Open MPI"</code></pre><p>The output of these commands should look similar to the following:</p><pre><code>Generating public/private rsa key pair.<br />Enter passphrase (empty for no passphrase):<br />Enter same passphrase again:<br />Your identification has been saved in /root/.ssh/id_rsa.<br />Your public key has been saved in /root/.ssh/id_rsa.pub.<br />The key fingerprint is:<br />35:85:97:3c:98:89:8d:bc:58:96:97:41:ad:0b:a6:c8 Enter an optional comment about your key<br />The key's randomart image is:<br />+--[ RSA 2048]----+<br />| &nbsp; &nbsp; &nbsp; . *oX.. &nbsp; |<br />| &nbsp; &nbsp; &nbsp; &nbsp;B O.* &nbsp; &nbsp;|<br />| &nbsp; &nbsp; &nbsp; + ooo . &nbsp; |<br />| &nbsp; &nbsp; &nbsp;. +... &nbsp; &nbsp; |<br />| &nbsp; . . oS. . &nbsp; &nbsp; |<br />| &nbsp; &nbsp;E . &nbsp; . &nbsp; &nbsp; &nbsp;|<br />| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |<br />| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |<br />| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |<br />+-----------------+<br /></code></pre><p><strong>Note:</strong> You will be prompted for a passphrase during this process. Leave it blank.</p><p>Copy the key to authorized key folder and change permissions to allow SSH logins:</p><pre><code>cat ~/.ssh/id_rsa.pub &gt;&gt; ~/.ssh/authorized_keys<br />chmod 600 ~/.ssh/authorized_keys&nbsp;</code></pre><h4>4. Configure HPC</h4><p>Now we are going to configure the master HPC node by creating a host file. To do this, ensure you are logged in to the first node over SSH and create the following file where &lt;Your Server IP&gt; is the IP address you used to SSH into the machine:</p><pre><code>cd ~/<br />echo &lt;Your Server IP&gt; &gt;&gt; mpi_hosts</code></pre><p>To verify the file:</p><pre><code>cat mpi_hosts</code></pre><p>You should see:</p><pre><code>&lt;Your Server IP&gt;</code></pre><p>To verify we have configured everything correctly so far, we will use the hello_c.c from the examples included with Open MPI.&nbsp;</p><p>To do this, follow these steps:</p><pre><code>mkdir /root/samples<br />cd /root/samples<br />wget http://svn.open-mpi.org/svn/ompi/tags/v1.6-series/v1.6.4/examples/hello_c.c<br />mpicc hello_c.c -o hello<br />mpirun ./hello</code></pre><p>This should output the following:</p><pre><code>Hello, world, I am 0 of 1</code></pre><p>Now that it works, get the second example, which we will use it for testing connectivity:</p><pre><code>wget http://svn.open-mpi.org/svn/ompi/tags/v1.6-series/v1.6.4/examples/connectivity_c.c<br />mpicc connectivity_c.c -o connectivity<br />mpirun ./connectivity</code></pre><p>You should see the following output:</p><pre><code>Connectivity test on 1 processes PASSED.</code></pre><p>Now that we have confirmed that the first node is online and operational, we will finish building the cluster.</p><h4>5. Create and Deploy a Cloud Server Image</h4><p>With our first node created, we are ready to set up a cluster. We will need to make copies of the node we just created. Login to <a href="https://mycloud.rackspace.com/">https://mycloud.rackspace.com</a> again and follow these steps to create an image:</p><ol><li>Navigate to the serverslist</li><li>Select the server you created for the first node</li><li>Click on the <strong>Actions </strong>drop down menu</li><li>Click <strong>Create Image</strong>.&nbsp;See <em>Figure 2</em> for details.</li><li>When prompted, provide a meaningful name as shown in <em>Figure 3</em>.</li><li>Finally, click <strong>Create Image</strong> and wait a few minutes for the image to be created.&nbsp;</li></ol><p><img src="/knowledge_center/sites/default/files/field/image/create%20image%20AM.png" alt="Creating a Server Image" width="431" height="139" /></p><p><em>Figure 2 - Creating a Server Image</em></p><p><img src="/knowledge_center/sites/default/files/field/image/create%20image.png" alt="Naming the Image" width="400" height="127" /></p><p><em>Figure 3 - Naming the Image</em></p><p>When completed, deploy a new Cloud Server using our prior procedure with the following exception; when prompted for image, click the Saved tab. Again, you will need to provide a meaningful name. Additionally, record the password and IP address.&nbsp;</p><p>Let’s say that the IP of your new server is 10.20.30.40, and the IP/hostname of your first server is &lt;Your Server IP&gt;. &nbsp;To add the new node to the cluster, do the following:</p><pre><code>SSH to your first server<br />cd ~/<br />cat &gt;&gt; mpi_hosts &lt;&lt;EOF <br />10.20.30.40 <br />EOF</code></pre><p>Now, your host file should resemble this:</p><pre><code>&lt;Your Server IP&gt;<br />10.20.30.40</code></pre><p>To test the connectivity between the nodes, execute the following command:</p><pre><code>mpirun -v -np 2 --hostfile ~/mpi_hosts /root/samples/connectivity</code></pre><p>If you don’t get any errors, you have just successfully created and tested your own tiny cloud cluster! To increase the size of the cluster, add two more nodes using the same procedure.&nbsp;</p><p>To test the connectivity between the four-node cluster, execute the following command:</p><pre><code>mpirun -v -np 4 --hostfile ~/mpi_hosts /root/samples/connectivity</code></pre><h4>6. Install and Run a Sample Open MPI enabled Application</h4><p>Now that we have an Open MPI cluster, let’s see how it performs. We will use a simple ray tracing application that can run on a single node or on an Open MPI cluster and compare the performance.&nbsp;</p><p>First, we will need to install this application on all nodes of the cluster. To do this, SSH into the master node and do the following:</p><pre><code>for i in `cat mpi_hosts`; do ssh root@$i "curl -l http://openstack.prov12n.com/files/tachyon.sh | bash"; done<br />cd ~/tachyon/compile/linux-mpi</code></pre><p>&nbsp;The Tachyon Parallel / Multiprocessor Ray Tracing System comes with multiple sample data files in the scenes folder, we will be using them to run our tests. First, lets run it on one node:</p><pre><code>cd ~/tachyon/compile/linux-mpi<br />./tachyon ../../scenes/teapot.dat&nbsp;</code></pre><p>You should see the following output:</p><pre><code>Tachyon Parallel/Multiprocessor Ray Tracer &nbsp; Version 0.99 &nbsp;&nbsp;<br />Copyright 1994-2011, &nbsp; &nbsp;John E. Stone &lt;john.stone@gmail.com&gt;&nbsp;<br />------------------------------------------------------------&nbsp;<br />Scene Parsing Time: &nbsp; &nbsp; 0.0221 seconds<br />Scene contains 2330 objects.<br />Preprocessing Time: &nbsp; &nbsp; 0.0052 seconds<br />Rendering Progress: &nbsp; &nbsp; &nbsp; 100% complete &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />&nbsp; Ray Tracing Time: &nbsp; &nbsp; 2.1399 seconds<br />&nbsp; &nbsp; Image I/O Time: &nbsp; &nbsp; 0.0174 seconds</code></pre><p>Note the ray tracing time as we will compare it to our parallel run:</p><pre><code>mpirun -np 4 --hostfile ~/mpi_hosts ./tachyon ../../scenes/teapot.dat -format BMP</code></pre><p>You should see the following output:</p><pre><code>Tachyon Parallel/Multiprocessor Ray Tracer &nbsp; Version 0.99 &nbsp;&nbsp;<br />Copyright 1994-2011, &nbsp; &nbsp;John E. Stone &lt;john.stone@gmail.com&gt;&nbsp;<br />------------------------------------------------------------&nbsp;<br />Scene Parsing Time: &nbsp; &nbsp; 0.0230 seconds<br />Scene contains 2330 objects.<br />Preprocessing Time: &nbsp; &nbsp; 0.0052 seconds<br />Rendering Progress: &nbsp; &nbsp; &nbsp; 100% complete &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />&nbsp; Ray Tracing Time: &nbsp; &nbsp; 0.6048 seconds<br />&nbsp; &nbsp; Image I/O Time: &nbsp; &nbsp; 0.0182 seconds</code></pre><p>Our cluster consisted of four nodes and one CPU each, therefore, the performance improvement was almost four times greater. Even if you don’t have multiple nodes and run your application on one node, but tell OpenMPI to use both CPUs, you will still have significant improvements. &nbsp;</p><p>This is why it is important that our server was created with at least 2GB of RAM because sizes 2GB and higher have access to at least 2 CPUs. For more information on sizes, see&nbsp;<a href="http://www.rackspace.com/cloud/servers/techdetails/">http://www.rackspace.com/cloud/servers/techdetails/</a>.</p><p>Now we can run this code on multiple CPUs of a single server.</p><pre><code>mpirun -np 2 ./tachyon ../../scenes/teapot.dat -format BMP</code></pre><p>You should see the following output:</p><pre><code>Tachyon Parallel/Multiprocessor Ray Tracer &nbsp; Version 0.99 &nbsp;&nbsp;<br />Copyright 1994-2011, &nbsp; &nbsp;John E. Stone &lt;john.stone@gmail.com&gt;&nbsp;<br />------------------------------------------------------------&nbsp;<br />Scene Parsing Time: &nbsp; &nbsp; 0.0222 seconds<br />Scene contains 2330 objects.<br />Preprocessing Time: &nbsp; &nbsp; 0.0050 seconds<br />Rendering Progress: &nbsp; &nbsp; &nbsp; 100% complete &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />&nbsp; Ray Tracing Time: &nbsp; &nbsp; 1.0888 seconds<br />&nbsp; &nbsp; Image I/O Time: &nbsp; &nbsp; 0.0181 seconds<br /></code></pre><p>Notice that even when running on a single node but utilizing Open MPI, the performance has almost doubled. To read more about this ray tracing application, visit <a href="http://jedi.ks.uiuc.edu/~johns/raytracer/">http://jedi.ks.uiuc.edu/~johns/raytracer/</a>.</p><h2>Summary</h2><p>In this tutorial, you learned how to create and image Cloud Servers. You also learned how to setup an HPC cluster using Open MPI. After setting up and configuring the cluster, you installed a small ray tracing application to demonstrate the benefits of using multiple nodes instead of one node.</p>
